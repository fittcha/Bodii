# Bodii - 기능 명세서

## 1. Phase 1: MVP (기본 추적 시스템)

### 1.1 체성분 관리

#### 1.1.1 체성분 입력
| 항목 | 설명 |
|------|------|
| **기능** | 사용자의 신체 정보를 입력/수정 |
| **입력 필드** | 키(cm), 몸무게(kg), 체지방량(kg), 체지방률(%), 골격근량(kg), 측정일 |
| **필수 여부** | 키, 몸무게 필수 / 체지방량, 체지방률, 골격근량 선택 |
| **자동 계산** | 체지방량 또는 체지방률 입력 시 다른 값 자동 계산 |
| **측정일 기본값** | 현재 일시 (now), 수정 가능 |
| **저장** | Core Data 로컬 저장 |
| **검증** | 키: 100~250cm, 몸무게: 20~300kg, 체지방률: 1~60% |

**체지방 자동 계산 공식:**
```
체지방량 입력 시: 체지방률 = (체지방량 / 몸무게) × 100
체지방률 입력 시: 체지방량 = 몸무게 × (체지방률 / 100)
```

**동일 날짜 체성분 입력 정책:**
```
- 같은 날 여러 번 입력 가능 (아침/저녁 측정 등)
- 히스토리: 모든 기록 표시 (시간순 정렬)
- 그래프: 동일 날짜는 가장 최근 기록 1건만 표시
- 대시보드: 오늘 가장 최근 체성분 표시
- User.current*: 항상 가장 최근 기록으로 업데이트
```

#### 1.1.2 체성분 히스토리
| 항목 | 설명 |
|------|------|
| **기능** | 입력된 체성분 기록 목록 조회 |
| **정렬** | 최신순 |
| **표시 정보** | 날짜, 몸무게, 체지방률, 이전 대비 변화량 |
| **액션** | 수정, 삭제 |

#### 1.1.3 체성분 그래프
| 항목 | 설명 |
|------|------|
| **기능** | 체성분 변화 추이를 그래프로 시각화 |
| **그래프 종류** | 라인 차트 |
| **표시 항목** | 몸무게, 체지방률, 골격근량, BMR, TDEE (토글 선택) |
| **기간 필터** | 1주, 1개월, 3개월, 6개월, 1년, 전체 |
| **데이터 소스** | MetabolismSnapshot (계산 없이 조회) |

---

### 1.2 기초/활동 대사량 계산

#### 1.2.1 기초대사량 (BMR) 계산
| 항목 | 설명 |
|------|------|
| **기능** | 체성분 기반 기초대사량 자동 계산 |
| **방식** | 하이브리드 (체지방률 유무에 따라 공식 선택) |
| **저장** | User.currentBMR + MetabolismSnapshot.bmr + DailyLog.bmr |

**체지방률 있을 때: Katch-McArdle 공식**
```
제지방량(LBM) = 체중 × (1 - 체지방률/100)
BMR = 370 + (21.6 × LBM)
```

**체지방률 없을 때: Mifflin-St Jeor 공식**
```
남성: BMR = 10 × 체중(kg) + 6.25 × 키(cm) - 5 × 나이 + 5
여성: BMR = 10 × 체중(kg) + 6.25 × 키(cm) - 5 × 나이 - 161
```

#### 1.2.2 활동대사량 (TDEE) 계산
| 항목 | 설명 |
|------|------|
| **기능** | 활동 수준에 따른 일일 소모 칼로리 계산 |
| **공식** | TDEE = BMR × 활동계수 |
| **활동계수** | 비활동적(1.2), 가벼운활동(1.375), 보통활동(1.55), 활동적(1.725), 매우활동적(1.9) |
| **저장** | User.currentTDEE + MetabolismSnapshot.tdee + DailyLog.tdee |

#### 1.2.3 BMR/TDEE 저장 전략

| 저장 위치 | 용도 | 업데이트 시점 |
|-----------|------|---------------|
| User.currentBMR/TDEE | 현재 대사량 (빠른 조회) | 체성분/활동수준/키/나이 변경 시 |
| MetabolismSnapshot | 체성분별 대사량 이력 | 체성분 입력 시 (1:1 생성) |
| DailyLog.bmr/tdee | 해당일 대사량 스냅샷 | DailyLog 생성 시 User에서 복사 |

**업데이트 트리거:**
| 이벤트 | 재계산 대상 | 업데이트 항목 |
|--------|-------------|---------------|
| 체성분 입력 | BMR, TDEE | User.current*, MetabolismSnapshot 생성, DailyLog(당일) |
| 활동 수준 변경 | TDEE만 | User.currentTDEE |
| 키 변경 | BMR, TDEE (체지방률 없을 때) | User.current* |
| 생년월일 변경 | BMR, TDEE (체지방률 없을 때) | User.current* |

---

### 1.3 음식 기록

#### 1.3.1 음식 검색 및 입력
| 항목 | 설명 |
|------|------|
| **기능** | 음식 DB에서 검색하여 기록 |
| **검색 우선순위** | 1) 식약처 DB (한국) → 2) USDA API (외국) → 3) 직접 입력 |
| **검색 방식** | 포함 검색, 초성 검색, 유사도 검색 |
| **입력 정보** | 음식명, 섭취량(g 또는 인분), 끼니(아침/점심/저녁/간식), 시간 |
| **표시 정보** | 칼로리, 탄수화물, 단백질, 지방 |

#### 1.3.2 음식 직접 입력
| 항목 | 설명 |
|------|------|
| **기능** | DB에 없는 음식 직접 입력 |
| **입력 필드** | 음식명, 칼로리, 탄수화물(g), 단백질(g), 지방(g), 섭취량 |
| **저장** | 사용자 정의 음식으로 로컬 저장 (재사용 가능) |

#### 1.3.3 일일 식단 조회
| 항목 | 설명 |
|------|------|
| **기능** | 선택한 날짜의 섭취 음식 목록 |
| **그룹핑** | 끼니별 (아침/점심/저녁/간식) |

**mealType 코드값:**
```
0: 아침 (Breakfast)
1: 점심 (Lunch)
2: 저녁 (Dinner)
3: 간식 (Snack)
```
| **합계** | 총 칼로리, 총 탄/단/지 (g) |
| **매크로 시각화** | 탄/단/지 비율 원 그래프 (%) |
| **액션** | 수정, 삭제 |
| **데이터 소스** | DailyLog (계산 없이 조회) |

#### 1.3.4 섭취 칼로리 그래프
| 항목 | 설명 |
|------|------|
| **기능** | 일별 섭취 칼로리 추이 |
| **그래프 종류** | 바 차트 또는 라인 차트 |
| **기간 필터** | 1주, 1개월 |
| **데이터 소스** | DailyLog.totalCaloriesIn |

---

#### 1.3.5 AI 식단 코멘트
| 항목 | 설명 |
|------|------|
| **기능** | 끼니 입력 완료 시 AI가 식단 분석 및 코멘트 생성 |
| **트리거** | 끼니 단위로 음식 추가 완료 후 "코멘트 보기" 버튼 클릭 시 |
| **API** | Google Gemini (월 무료, 15 RPM) |
| **분석 요소** | 칼로리(TDEE 대비), 매크로 비율, 음식 종류 |
| **저장 정책** | 캐싱 안 함 - 매번 API 호출 (API 비용 절감 위해 사용자 수동 호출) |
| **오프라인 시** | "네트워크 연결 필요" 메시지 표시 |

#### 1.3.6 코멘트 출력 형식
| 항목 | 설명 |
|------|------|
| **좋은 점** | 식단의 긍정적인 부분 (1~2줄) |
| **개선점** | 개선하면 좋은 점 (1~2줄) |
| **총평** | 전체 평가 및 조언 (1~2줄) |
| **식단 점수** | 0~10점 + 색상 표시 |

#### 1.3.7 식단 점수 기준
| 점수 | 색상 | 상태 |
|------|------|------|
| 8~10 | 🟢 초록 | Great |
| 5~7 | 🟡 노랑 | Good |
| 0~4 | 🔴 빨강 | Needs Work |

#### 1.3.8 음식 기록 저장 시 연쇄 업데이트
```
음식 추가 시:
1. FoodRecord 저장
2. DailyLog.totalCaloriesIn += calculatedCalories
3. DailyLog.totalCarbs/Protein/Fat += 각 영양소
4. DailyLog.*Ratio 재계산
5. DailyLog.netCalories 재계산

음식 삭제 시:
1. FoodRecord 삭제
2. DailyLog.totalCaloriesIn -= calculatedCalories
3. DailyLog.totalCarbs/Protein/Fat -= 각 영양소
4. DailyLog.*Ratio 재계산
5. DailyLog.netCalories 재계산
```

---

### 1.4 운동 기록

#### 1.4.1 운동 입력
| 항목 | 설명 |
|------|------|
| **기능** | 수행한 운동 기록 |
| **입력 필드** | 운동 종류, 시간(분), 강도(저/중/고), 날짜 |
| **운동 종류** | 걷기, 달리기, 자전거, 수영, 웨이트, 크로스핏, 요가, 기타 |
| **칼로리 계산** | MET 값 기반 자동 계산 |
| **검증** | 시간: 최소 1분 이상 |

#### 1.4.2 MET 기반 칼로리 계산
| 항목 | 설명 |
|------|------|
| **공식** | 소모칼로리 = MET × 체중(kg) × 시간(h) |
| **체중 소스** | User.currentWeight (저장된 값 사용) |
| **MET 값** | 운동 종류 × 강도에 따라 결정 |

#### 1.4.3 운동 히스토리
| 항목 | 설명 |
|------|------|
| **기능** | 운동 기록 목록 |
| **정렬** | 최신순 |
| **표시 정보** | 날짜, 운동 종류, 시간, 소모 칼로리 |

#### 1.4.4 운동 기록 저장 시 연쇄 업데이트
```
운동 추가 시:
1. ExerciseRecord 저장
2. DailyLog.totalCaloriesOut += caloriesBurned
3. DailyLog.exerciseMinutes += duration
4. DailyLog.exerciseCount += 1

운동 삭제 시:
1. ExerciseRecord 삭제
2. DailyLog.totalCaloriesOut -= caloriesBurned
3. DailyLog.exerciseMinutes -= duration
4. DailyLog.exerciseCount -= 1
```

---

### 1.5 Apple HealthKit 연동

#### 1.5.1 데이터 읽기
| 항목 | 설명 |
|------|------|
| **기능** | HealthKit에서 데이터 가져오기 |
| **읽기 항목** | 걸음 수, 활동 칼로리, 운동 기록, 체중 |
| **동기화** | 앱 실행 시 또는 수동 새로고침 |
| **저장** | DailyLog.steps 업데이트 |

#### 1.5.2 데이터 쓰기
| 항목 | 설명 |
|------|------|
| **기능** | Bodii 데이터를 HealthKit에 저장 |
| **쓰기 항목** | 체중, 체지방률, 식이 칼로리 |
| **권한** | 사용자 동의 필요 |

#### 1.5.3 HealthKit 운동 중복 처리
```
HealthKit에서 운동 가져올 때:
1. healthKitId로 기존 기록 확인
2. 이미 있으면 스킵
3. 없으면 ExerciseRecord 생성 (fromHealthKit = true)
```

---

### 1.6 수면 관리

#### 1.6.1 수면 시간 입력 팝업
| 항목 | 설명 |
|------|------|
| **기능** | 새벽 2시 이후 첫 실행 시 수면 시간 입력 팝업 |
| **하루 기준** | 02:00 ~ 다음날 02:00 |
| **팝업 조건** | 해당 하루 기준 첫 실행 시만 표시 |
| **UI** | Picker Wheel (시 / 분, 10분 단위) |
| **저장** | SleepRecord Entity + DailyLog.sleepDuration/Status 업데이트 |
| **입력 범위** | 최소 0분 ~ 최대 24시간 (밤샘 = 0분 가능) |

**"나중에" 버튼 선택 시:**
```
- 해당 하루 내 다음 앱 실행 시 다시 팝업 표시
- 하루 최대 3회까지 재팝업 (이후는 수면 탭에서 직접 입력 유도)
- 3회 스킵 시: 해당 날짜 SleepRecord는 null로 유지
- 수면 탭에서 언제든 직접 입력/수정 가능
```

#### 1.6.2 수면 상태 표시
| 코드 | 상태 | 수면 시간 | 색상 |
|------|------|----------|------|
| 0 | Bad | 5시간 30분 미만 (< 330분) | 🔴 빨강 |
| 1 | Soso | 5시간 30분 ~ 6시간 30분 (330 ~ 390분) | 🟡 노랑 |
| 2 | Good | 6시간 30분 ~ 7시간 30분 (390 ~ 450분) | 🟢 초록 |
| 3 | Excellent | 7시간 30분 ~ 9시간 (450 ~ 540분) | 🔵 파랑 |
| 4 | Oversleep | 9시간 초과 (> 540분) | 🟠 주황 |

#### 1.6.3 수면 히스토리
| 항목 | 설명 |
|------|------|
| **기능** | 수면 기록 목록 조회 |
| **정렬** | 최신순 |
| **표시 정보** | 날짜, 수면 시간, 상태 (색상 아이콘) |
| **액션** | 날짜 클릭 시 수정 가능 |

#### 1.6.4 수면 그래프
| 항목 | 설명 |
|------|------|
| **기능** | 수면 시간 변화 추이 시각화 |
| **그래프 종류** | 바 차트 (상태별 색상) |
| **기간 필터** | 1주, 1개월, 3개월 |
| **평균선** | 기간 평균 수면 시간 표시 |
| **데이터 소스** | DailyLog.sleepDuration/Status |

#### 1.6.5 수면 기록 저장 시 연쇄 업데이트
```
수면 입력 시:
1. SleepRecord 저장
2. DailyLog.sleepDuration = duration
3. DailyLog.sleepStatus = 계산된 상태
```

---

### 1.7 대시보드

#### 1.7.1 일일 요약
| 항목 | 설명 |
|------|------|
| **기능** | 오늘의 건강 현황 한눈에 보기 |
| **표시 항목** | 섭취 칼로리 / TDEE, 남은 칼로리, 탄/단/지 비율, 운동 소모 칼로리, 수면 상태 |
| **시각화** | 원형 진행 바, 매크로 바 차트, 수면 상태 아이콘 |
| **데이터 소스** | User (현재 대사량) + DailyLog (오늘 기록) |
| **계산 여부** | ❌ 없음 (저장된 값만 조회) |

#### 1.7.2 대시보드 조회 로직
```
대시보드 로딩 시:
1. User 조회 → currentTDEE, currentWeight
2. DailyLog(오늘) 조회 → totalCaloriesIn, netCalories, *Ratio, sleepStatus
3. 계산 없이 바로 표시
```

---

### 1.8 DailyLog 관리

#### 1.8.1 DailyLog 생성 정책
| 항목 | 설명 |
|------|------|
| **생성 시점** | 해당 날짜에 첫 기록 (음식/운동/체성분/수면) 시 |
| **초기화 값** | User.currentBMR/TDEE 복사, 나머지 0 또는 null |
| **하루 기준** | 00:00 ~ 23:59 (수면만 02:00 기준) |

#### 1.8.2 DailyLog 초기 생성 시 값
```
DailyLog 생성 시:
- bmr = User.currentBMR
- tdee = User.currentTDEE
- netCalories = -tdee (아직 섭취 0)
- totalCaloriesIn = 0
- totalCarbs/Protein/Fat = 0
- totalCaloriesOut = 0
- exerciseMinutes/Count = 0
- weight = User.currentWeight (있으면)
- bodyFatPct = User.currentBodyFatPct (있으면)
- sleepDuration/Status = null
- steps = null
```

#### 1.8.3 과거 날짜 DailyLog 정책
```
과거 날짜에 기록 추가 시:
- DailyLog 없으면 → 해당 시점 User 값으로 생성 (불가능하므로 현재 값 사용)
- 과거 DailyLog의 bmr/tdee는 변경하지 않음 (당시 스냅샷 유지)
```

---

## 2. Phase 2: AI 기능

### 2.1 음식 사진 인식

#### 2.1.1 사진 촬영/선택
| 항목 | 설명 |
|------|------|
| **기능** | 카메라 촬영 또는 갤러리에서 선택 |
| **권한** | 카메라, 사진 라이브러리 접근 권한 |

#### 2.1.2 AI 음식 인식
| 항목 | 설명 |
|------|------|
| **기능** | 사진에서 음식 종류 자동 인식 |
| **API** | Google Cloud Vision (Label Detection) |
| **프로세스** | 1) 사진 → Vision API → 라벨 추출 → 2) 라벨로 식약처 DB 검색 → 3) 없으면 USDA API 검색 → 4) 매칭 결과 제안 |
| **제한** | 월 1,000건 (무료 티어) |

#### 2.1.3 인식 결과 수정
| 항목 | 설명 |
|------|------|
| **기능** | AI 인식 결과를 사용자가 수정 |
| **UI** | 인식된 음식 목록 → 선택/수정/삭제 → 양 조절 → 확정 |
| **학습** | 사용자 수정 내역 로컬 저장 (향후 개선용) |

---

### 2.2 목표 관리

#### 2.2.1 목표 설정
| 항목 | 설명 |
|------|------|
| **기능** | 건강 목표 설정 (다중 목표 지원) |
| **목표 유형** | 감량(0), 유지(1), 증량(2) |
| **목표 항목** | 체중(kg), 체지방률(%), 근육량(kg) - 각각 독립 설정 가능 |
| **입력 정보** | 목표값, 주간 변화량 (예: 체중 -0.5kg/주, 근육량 +0.1kg/주) |
| **필수 조건** | 최소 1개 이상 목표 설정 |
| **검증** | 복수 목표 시 물리적 정합성 체크 |
| **저장** | Goal Entity + 시작 시점 BMR/TDEE 스냅샷 |

**목표 정합성 검증:**
```
체중, 체지방률, 근육량 복수 설정 시:
1. 체지방량 = 목표체중 × (목표체지방률 / 100)
2. 제지방량 = 목표체중 - 체지방량
3. 제지방량 ≥ 목표근육량 (근육은 제지방의 일부)

예시: 53kg, 18%, 25kg
- 체지방량 = 53 × 0.18 = 9.54kg
- 제지방량 = 53 - 9.54 = 43.46kg
- 43.46 ≥ 25 → ✅ 유효
```

#### 2.2.2 예상 진행 그래프
| 항목 | 설명 |
|------|------|
| **기능** | 목표 대비 예상 경로 시각화 |
| **그래프** | 설정된 목표만 그래프 표시 |
| **표시 로직** | 체중만 → 체중 그래프 / 근육량만 → 근육 그래프 / 복수 → 탭 전환 |
| **업데이트** | 실제 기록 반영하여 예상 그래프 실시간 조정 |

#### 2.2.3 목표 달성률
| 항목 | 설명 |
|------|------|
| **기능** | 목표 대비 현재 진행 상황 |
| **표시** | 항목별 퍼센트, 예상 달성일 |
| **계산** | (현재값 - 시작값) / (목표값 - 시작값) × 100 |

---

## 3. Phase 3: 소셜 기능

### 3.1 계정 시스템

#### 3.1.1 회원가입/로그인
| 항목 | 설명 |
|------|------|
| **방식** | 이메일/비밀번호, Apple 로그인, 소셜 로그인 |
| **필수 정보** | 이메일, 닉네임 |
| **인증** | 이메일 인증 또는 OAuth |

#### 3.1.2 프로필
| 항목 | 설명 |
|------|------|
| **표시 정보** | 닉네임, 프로필 사진, 소개, 목표, 달성 배지 |
| **공개 설정** | 전체 공개, 친구만, 비공개 |

---

### 3.2 친구 기능

#### 3.2.1 친구 추가
| 항목 | 설명 |
|------|------|
| **방식** | 닉네임 검색, 초대 링크, QR 코드 |
| **프로세스** | 요청 → 수락/거절 |

#### 3.2.2 친구 목록
| 항목 | 설명 |
|------|------|
| **표시 정보** | 닉네임, 프로필 사진, 오늘 활동 요약 |
| **액션** | 프로필 보기, 응원하기, 삭제 |

---

### 3.3 커뮤니티

#### 3.3.1 피드
| 항목 | 설명 |
|------|------|
| **기능** | 사용자 활동 공유 |
| **공유 가능 항목** | 오늘의 식단, 운동 기록, 목표 달성, 체성분 변화 |
| **인터랙션** | 좋아요, 댓글, 응원 |

#### 3.3.2 챌린지
| 항목 | 설명 |
|------|------|
| **기능** | 그룹 목표 도전 |
| **예시** | 7일 연속 기록, 주간 운동 시간 챌린지 |
| **보상** | 배지, 랭킹 포인트 |

#### 3.3.3 랭킹
| 항목 | 설명 |
|------|------|
| **기능** | 활동 기반 순위 |
| **기준** | 연속 기록 일수, 목표 달성률, 챌린지 참여 |
| **범위** | 친구 간, 전체 |

---

## 4. 비기능 요구사항

### 4.1 성능
| 항목 | 기준 |
|------|------|
| 앱 실행 시간 | 3초 이내 |
| 화면 전환 | 0.3초 이내 |
| 대시보드 로딩 | 0.5초 이내 (DB 쿼리 2건) |
| API 응답 대기 | 로딩 인디케이터 표시 |

### 4.2 보안
| 항목 | 설명 |
|------|------|
| 로컬 데이터 | Core Data 암호화 (Phase 3에서 적용) |
| API 키 | 앱 내 하드코딩 금지, 환경변수 또는 서버 경유 |
| 네트워크 | HTTPS 필수 |

### 4.3 오프라인 지원
| 항목 | 설명 |
|------|------|
| Phase 1-2 | 완전 오프라인 사용 가능 (API 호출 제외) |
| Phase 3 | 개인 데이터는 오프라인, 소셜 기능은 온라인 필요 |

**오프라인 모드 UX 상세:**
```
사용 가능 기능:
- 체성분 입력/조회/그래프
- 식단 기록 (최근 먹은 음식, 사용자 정의 음식으로 제한)
- 운동 기록
- 수면 기록
- 대시보드 조회 (저장된 값)
- 모든 히스토리 조회

제한되는 기능 (+ UX):
- 음식 검색: "네트워크 필요" 메시지 + "직접 입력" 버튼
- AI 식단 코멘트: "네트워크 필요" 메시지 (Phase 1)
- 음식 사진 인식: "네트워크 필요" 메시지 (Phase 2)

네트워크 복구 시:
- 별도 동기화 없음 (로컬 저장이므로)
- 정상 기능 즉시 사용 가능
```

### 4.4 접근성
| 항목 | 설명 |
|------|------|
| VoiceOver | 지원 |
| Dynamic Type | 시스템 폰트 크기 대응 |
| 색상 대비 | WCAG 2.1 AA 기준 |

---

*문서 버전: 2.0*
*작성일: 2026-01-11*
*수정: BMR/TDEE 저장 전략 추가, 연쇄 업데이트 정책 추가, DailyLog 관리 섹션 추가, 데이터 소스 명시*
