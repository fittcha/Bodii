{
  "file_path": "BodiiTests/Mappers/FoodEntityMapperTests.swift",
  "main_branch_history": [],
  "task_views": {
    "005-korean-food-database-integration": {
      "task_id": "005-korean-food-database-integration",
      "branch_point": {
        "commit_hash": "c44bfbcd7c1699b176a8bb155e8c35f43ebd4ad9",
        "content": "",
        "timestamp": "2026-01-13T07:46:23.878686"
      },
      "worktree_state": {
        "content": "//\n//  FoodEntityMapperTests.swift\n//  BodiiTests\n//\n//  Created by Auto-Claude on 2026-01-13.\n//\n\nimport XCTest\nimport CoreData\n@testable import Bodii\n\n/// Unit tests for FoodEntityMapper bidirectional mapping\n///\n/// FoodEntityMapper\uc758 \uc591\ubc29\ud5a5 \ub9e4\ud551 \ub2e8\uc704 \ud14c\uc2a4\ud2b8 (Food \u2194 FoodEntity)\nfinal class FoodEntityMapperTests: XCTestCase {\n\n    // MARK: - Properties\n\n    var mapper: FoodEntityMapper!\n    var context: NSManagedObjectContext!\n\n    // MARK: - Setup & Teardown\n\n    override func setUp() {\n        super.setUp()\n        mapper = FoodEntityMapper()\n\n        // Create in-memory Core Data context for testing\n        let persistenceController = PersistenceController.preview\n        context = persistenceController.container.viewContext\n    }\n\n    override func tearDown() {\n        mapper = nil\n        context = nil\n        super.tearDown()\n    }\n\n    // MARK: - Domain to Core Data Mapping Tests\n\n    /// Test: Food domain entity maps to FoodEntity Core Data object successfully\n    ///\n    /// \ud14c\uc2a4\ud2b8: Food \ub3c4\uba54\uc778 \uc5d4\ud2f0\ud2f0\uac00 FoodEntity Core Data \uac1d\uccb4\ub85c \uc131\uacf5\uc801\uc73c\ub85c \ubcc0\ud658\ub428\n    func testToEntity_ValidFood_ReturnsFoodEntity() {\n        // Given: Valid Food domain entity\n        let food = Bodii.Food(\n            id: UUID(),\n            name: \"\ud604\ubbf8\ubc25\",\n            calories: 330,\n            carbohydrates: Decimal(73.4),\n            protein: Decimal(6.8),\n            fat: Decimal(2.5),\n            sodium: Decimal(5),\n            fiber: Decimal(3.0),\n            sugar: Decimal(0.5),\n            servingSize: Decimal(210),\n            servingUnit: \"1\uacf5\uae30\",\n            source: .governmentAPI,\n            apiCode: \"D000001\",\n            createdByUserId: nil,\n            createdAt: Date()\n        )\n\n        // When: Mapping to Core Data entity\n        let entity = mapper.toEntity(from: food, context: context)\n\n        // Then: Should map all fields correctly\n        XCTAssertEqual(entity.id, food.id, \"ID should match\")\n        XCTAssertEqual(entity.name, \"\ud604\ubbf8\ubc25\", \"Name should match\")\n        XCTAssertEqual(entity.calories, 330, \"Calories should match\")\n        XCTAssertEqual(entity.source, Int16(FoodSource.governmentAPI.rawValue), \"Source should be governmentAPI\")\n        XCTAssertEqual(entity.apiCode, \"D000001\", \"API code should match\")\n    }\n\n    /// Test: Batch mapping with valid domain foods\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc720\ud6a8\ud55c \ub3c4\uba54\uc778 \uc5d4\ud2f0\ud2f0\uc758 \ubc30\uce58 \ub9e4\ud551\n    func testToEntityArray_ValidFoods_ReturnsAllEntities() {\n        // Given: Array of valid Food domain entities\n        let foods = [\n            createSampleFood(apiCode: \"D000001\", name: \"\ud604\ubbf8\ubc25\", calories: 330),\n            createSampleFood(apiCode: \"D000002\", name: \"\uae40\uce58\ucc0c\uac1c\", calories: 150),\n            createSampleFood(apiCode: \"D000003\", name: \"\ub41c\uc7a5\ucc0c\uac1c\", calories: 120)\n        ]\n\n        // When: Batch mapping to Core Data entities\n        let entities = mapper.toEntityArray(from: foods, context: context)\n\n        // Then: All foods should be mapped\n        XCTAssertEqual(entities.count, 3, \"Should map all 3 foods\")\n        XCTAssertEqual(entities[0].name, \"\ud604\ubbf8\ubc25\", \"First entity name should match\")\n        XCTAssertEqual(entities[1].name, \"\uae40\uce58\ucc0c\uac1c\", \"Second entity name should match\")\n        XCTAssertEqual(entities[2].name, \"\ub41c\uc7a5\ucc0c\uac1c\", \"Third entity name should match\")\n    }\n\n    // MARK: - Upsert Tests\n\n    /// Test: saveUnique with new foods (inserts all)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc0c8\ub85c\uc6b4 \uc74c\uc2dd\ub4e4\uc758 saveUnique (\ubaa8\ub450 \uc0bd\uc785\ub428)\n    func testSaveUnique_AllNewFoods_InsertsAll() throws {\n        // Given: Array of new foods\n        let foods = [\n            createSampleFood(apiCode: \"D0001\", name: \"Food 1\"),\n            createSampleFood(apiCode: \"D0002\", name: \"Food 2\"),\n            createSampleFood(apiCode: \"D0003\", name: \"Food 3\")\n        ]\n\n        // When: Saving unique foods\n        let insertedCount = try mapper.saveUnique(from: foods, context: context)\n\n        // Then: All should be inserted\n        XCTAssertEqual(insertedCount, 3, \"Should insert all 3 new foods\")\n    }\n\n    /// Test: Saving duplicate foods (upserts instead of duplicating)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc911\ubcf5 \uc74c\uc2dd \uc800\uc7a5 (\uc911\ubcf5 \ub300\uc2e0 \uc5c5\ub370\uc774\ud2b8)\n    func testSaveUnique_DuplicateFoods_UpdatesInsteadOfDuplicating() throws {\n        // Given: Initial food saved to Core Data\n        let originalFood = createSampleFood(apiCode: \"D0001\", name: \"Original Name\")\n        _ = try mapper.saveUnique(from: [originalFood], context: context)\n\n        // When: Saving updated food with same apiCode\n        let updatedFood = createSampleFood(apiCode: \"D0001\", name: \"Updated Name\")\n        let insertedCount = try mapper.saveUnique(from: [updatedFood], context: context)\n\n        // Then: Should update instead of insert (insertedCount = 0)\n        XCTAssertEqual(insertedCount, 0, \"Should update existing food, not insert new\")\n\n        // Verify updated name\n        let fetchRequest: NSFetchRequest<Food> = Food.fetchRequest()\n        fetchRequest.predicate = NSPredicate(format: \"apiCode == %@\", \"D0001\")\n        let results = try context.fetch(fetchRequest)\n\n        XCTAssertEqual(results.count, 1, \"Should have exactly 1 food with apiCode D0001\")\n        XCTAssertEqual(results.first?.name, \"Updated Name\", \"Name should be updated\")\n    }\n\n    /// Test: Saving mix of new and duplicate foods\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc0c8 \uc74c\uc2dd\uacfc \uc911\ubcf5 \uc74c\uc2dd \ud63c\ud569 \uc800\uc7a5\n    func testSaveUnique_MixOfNewAndDuplicate_HandlesCorrectly() throws {\n        // Given: Initial foods saved to Core Data\n        let existingFoods = [\n            createSampleFood(apiCode: \"D0001\", name: \"Food 1\"),\n            createSampleFood(apiCode: \"D0002\", name: \"Food 2\")\n        ]\n        _ = try mapper.saveUnique(from: existingFoods, context: context)\n\n        // When: Saving mix of new and duplicate foods\n        let mixedFoods = [\n            createSampleFood(apiCode: \"D0001\", name: \"Food 1 Updated\"), // Duplicate\n            createSampleFood(apiCode: \"D0003\", name: \"Food 3\"),         // New\n            createSampleFood(apiCode: \"D0004\", name: \"Food 4\")          // New\n        ]\n        let insertedCount = try mapper.saveUnique(from: mixedFoods, context: context)\n\n        // Then: Should insert only new foods\n        XCTAssertEqual(insertedCount, 2, \"Should insert only 2 new foods\")\n\n        // Verify total count\n        let fetchRequest: NSFetchRequest<Food> = Food.fetchRequest()\n        let allFoods = try context.fetch(fetchRequest)\n        XCTAssertEqual(allFoods.count, 4, \"Should have 4 total foods (2 original + 2 new)\")\n    }\n\n    // MARK: - Helper Methods\n\n    /// Create a sample Food entity for testing\n    private func createSampleFood(\n        apiCode: String,\n        name: String,\n        calories: Int32 = 100,\n        carbs: Decimal = 20,\n        protein: Decimal = 5,\n        fat: Decimal = 3\n    ) -> Bodii.Food {\n        return Bodii.Food(\n            id: UUID(),\n            name: name,\n            calories: calories,\n            carbohydrates: carbs,\n            protein: protein,\n            fat: fat,\n            sodium: nil,\n            fiber: nil,\n            sugar: nil,\n            servingSize: 100,\n            servingUnit: nil,\n            source: .governmentAPI,\n            apiCode: apiCode,\n            createdByUserId: nil,\n            createdAt: Date()\n        )\n    }\n}\n",
        "last_modified": "2026-01-14T22:55:39.268408"
      },
      "task_intent": {
        "title": "005-korean-food-database-integration",
        "description": "Integrate Korean Food & Drug Administration (\uc2dd\uc57d\ucc98) food nutrition database API as primary source, with USDA FoodData Central as fallback for international foods. Prioritize Korean dishes (kimchi jjigae, bibimbap, tteokbokki) that are poorly covered by competitors.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-13T07:43:31.843470",
  "last_updated": "2026-01-13T07:46:24.188370"
}