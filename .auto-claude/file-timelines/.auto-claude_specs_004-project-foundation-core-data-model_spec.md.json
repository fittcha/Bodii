{
  "file_path": ".auto-claude/specs/004-project-foundation-core-data-model/spec.md",
  "main_branch_history": [],
  "task_views": {
    "004-project-foundation-core-data-model": {
      "task_id": "004-project-foundation-core-data-model",
      "branch_point": {
        "commit_hash": "2abdae73fb6199bcbf4f21f6deeb7952225f81e6",
        "content": "",
        "timestamp": "2026-01-12T19:14:54.682468"
      },
      "worktree_state": {
        "content": "# Specification: Project Foundation & Core Data Model\n\n## Overview\n\nThis task establishes the foundation layer for the Bodii health/fitness tracking iOS application. It implements the complete type system (enums), utility services for date handling with a critical **02:00 sleep boundary** rule, domain entities representing the core business objects, and Core Data persistence extensions. This foundation enables all subsequent features including body composition tracking, meal logging, exercise tracking, and sleep monitoring.\n\n## Workflow Type\n\n**Type**: feature\n\n**Rationale**: This is a new feature implementation that creates the entire foundation layer from scratch. It involves multiple interconnected components (enums, utilities, domain entities, persistence) that must work together cohesively. The domain-driven design requires careful implementation of business rules embedded in the type system.\n\n## Task Scope\n\n### Services Involved\n- **main** (primary) - Single iOS application with SwiftUI and Core Data\n\n### This Task Will:\n- [ ] Define all application enums (Gender, ActivityLevel, MealType, ExerciseType, Intensity, FoodSource, GoalType, SleepStatus, QuantityUnit, Constants)\n- [ ] Implement DateUtils with 02:00 sleep boundary logic\n- [ ] Create ValidationService for input validation\n- [ ] Add Date+Extensions and Decimal+Extensions\n- [ ] Build Formatters utility for display formatting\n- [ ] Define 9 domain entities (User, BodyRecord, MetabolismSnapshot, Food, FoodRecord, ExerciseRecord, SleepRecord, DailyLog, Goal)\n- [ ] Create Core Data entity extensions for persistence mapping\n- [ ] Write unit tests for DateUtils, ValidationService, and SleepStatus\n\n### Out of Scope:\n- UI/View layer implementation\n- Repository/Service layer implementation\n- HealthKit integration\n- API integration (Food search, AI features)\n- iCloud synchronization\n\n## Service Context\n\n### Main Service (iOS App)\n\n**Tech Stack:**\n- Language: Swift\n- Framework: SwiftUI\n- Persistence: Core Data\n- Package Manager: Xcode\n\n**Entry Point:** `Bodii/App/BodiiApp.swift`\n\n**How to Run:**\n```bash\nopen Bodii.xcodeproj\n# Build and run in Xcode (Cmd+R)\n```\n\n**Port:** N/A (Native iOS application)\n\n**Key Directories:**\n- `Bodii/Shared/Enums/` - Type definitions\n- `Bodii/Shared/Utils/` - Utility services\n- `Bodii/Shared/Extensions/` - Swift extensions\n- `Bodii/Domain/Entities/` - Domain models\n- `Bodii/Infrastructure/Persistence/` - Core Data\n\n## Files to Modify\n\n| File | Service | What to Change |\n|------|---------|---------------|\n| `Bodii/Shared/Enums/Gender.swift` | main | Create Gender enum with male/female cases, Int16 rawValue |\n| `Bodii/Shared/Enums/ActivityLevel.swift` | main | Create ActivityLevel enum with 5 levels and multiplier property |\n| `Bodii/Shared/Enums/MealType.swift` | main | Create MealType enum (breakfast/lunch/dinner/snack) |\n| `Bodii/Shared/Enums/ExerciseType.swift` | main | Create ExerciseType enum with 8 exercise types and MET values |\n| `Bodii/Shared/Enums/Intensity.swift` | main | Create Intensity enum (low/medium/high) with multipliers |\n| `Bodii/Shared/Enums/FoodSource.swift` | main | Create FoodSource enum (API sources, user-defined) |\n| `Bodii/Shared/Enums/GoalType.swift` | main | Create GoalType enum (lose/maintain/gain) |\n| `Bodii/Shared/Enums/SleepStatus.swift` | main | Create SleepStatus enum with duration-based factory method |\n| `Bodii/Shared/Enums/QuantityUnit.swift` | main | Create QuantityUnit enum (serving/grams) |\n| `Bodii/Shared/Utils/Constants.swift` | main | Create Constants enum with app-wide configuration values |\n| `Bodii/Shared/Utils/DateUtils.swift` | main | Create DateUtils with 02:00 sleep boundary logic |\n| `Bodii/Shared/Utils/ValidationService.swift` | main | Create ValidationService with input validation rules |\n| `Bodii/Shared/Utils/Formatters.swift` | main | Create Formatters for consistent display formatting |\n| `Bodii/Shared/Extensions/Date+Extensions.swift` | main | Add date manipulation and age calculation extensions |\n| `Bodii/Shared/Extensions/Decimal+Extensions.swift` | main | Add decimal formatting and arithmetic extensions |\n| `Bodii/Domain/Entities/User.swift` | main | Create User domain entity struct |\n| `Bodii/Domain/Entities/BodyRecord.swift` | main | Create BodyRecord domain entity struct |\n| `Bodii/Domain/Entities/MetabolismSnapshot.swift` | main | Create MetabolismSnapshot domain entity struct |\n| `Bodii/Domain/Entities/Food.swift` | main | Create Food domain entity struct |\n| `Bodii/Domain/Entities/FoodRecord.swift` | main | Create FoodRecord domain entity struct |\n| `Bodii/Domain/Entities/ExerciseRecord.swift` | main | Create ExerciseRecord domain entity struct |\n| `Bodii/Domain/Entities/SleepRecord.swift` | main | Create SleepRecord domain entity struct |\n| `Bodii/Domain/Entities/DailyLog.swift` | main | Create DailyLog domain entity struct |\n| `Bodii/Domain/Entities/Goal.swift` | main | Create Goal domain entity struct |\n| `Bodii/Infrastructure/Persistence/Bodii.xcdatamodeld` | main | Define Core Data entities matching domain models |\n| `BodiiTests/DateUtilsTests.swift` | main | Unit tests for DateUtils including 02:00 boundary |\n| `BodiiTests/ValidationServiceTests.swift` | main | Unit tests for ValidationService |\n| `BodiiTests/SleepStatusTests.swift` | main | Unit tests for SleepStatus.from(durationMinutes:) |\n\n## Files to Reference\n\nThese files show patterns to follow:\n\n| File | Pattern to Copy |\n|------|----------------|\n| `docs/04_ERD.md` | Entity structure, relationships, field types, and constraints |\n| `docs/02_FEATURE_SPEC.md` | Business rules, validation ranges, calculation formulas |\n| `docs/06_ALGORITHM.md` | BMR/TDEE formulas, MET values, calculation logic |\n| `docs/08_EDGE_CASES.md` | Edge cases, validation rules, error handling |\n\n## Patterns to Follow\n\n### Pattern 1: Enum with Int16 RawValue for Core Data\n\nFrom existing codebase pattern:\n\n```swift\nenum Gender: Int16, CaseIterable, Codable {\n    case male = 0\n    case female = 1\n\n    var displayName: String {\n        switch self {\n        case .male: return \"\ub0a8\uc131\"\n        case .female: return \"\uc5ec\uc131\"\n        }\n    }\n}\n\nextension Gender: Identifiable {\n    var id: Int16 { rawValue }\n}\n```\n\n**Key Points:**\n- Use Int16 rawValue for Core Data compatibility\n- Implement CaseIterable for iteration in UI\n- Implement Codable for serialization\n- Add displayName computed property for Korean localization\n- Extend with Identifiable for SwiftUI\n\n### Pattern 2: Domain Entity as Struct\n\nFrom existing codebase pattern:\n\n```swift\nstruct User: Identifiable, Codable, Equatable {\n    let id: UUID\n    var name: String\n    var gender: Gender\n    // ... other properties\n\n    var age: Int {\n        Date.age(from: birthDate)\n    }\n}\n\nextension User: CustomStringConvertible {\n    var description: String { /* debug output */ }\n}\n```\n\n**Key Points:**\n- Use struct for immutability and value semantics\n- Implement Identifiable, Codable, Equatable\n- Use let for immutable fields (id, createdAt)\n- Use var for mutable fields\n- Add computed properties for derived values\n- Extend with CustomStringConvertible for debugging\n\n### Pattern 3: Static Utility Methods\n\nFrom DateUtils pattern:\n\n```swift\nenum DateUtils {\n    static func getLogicalDate(for date: Date) -> Date {\n        let calendar = Calendar.current\n        let hour = calendar.component(.hour, from: date)\n\n        if hour < Constants.Sleep.boundaryHour {\n            guard let previousDay = calendar.date(byAdding: .day, value: -1, to: date) else {\n                return calendar.startOfDay(for: date)\n            }\n            return calendar.startOfDay(for: previousDay)\n        }\n        return calendar.startOfDay(for: date)\n    }\n}\n```\n\n**Key Points:**\n- Use enum with no cases as namespace for static methods\n- Reference Constants for magic numbers\n- Document with comprehensive docstrings\n- Handle edge cases with guard statements\n\n### Pattern 4: Factory Method in Enum\n\nFrom SleepStatus pattern:\n\n```swift\nstatic func from(durationMinutes: Int) -> SleepStatus {\n    switch durationMinutes {\n    case ..<330: return .bad\n    case 330..<390: return .soso\n    case 390..<450: return .good\n    case 450...540: return .excellent\n    default: return .oversleep\n    }\n}\n```\n\n**Key Points:**\n- Use static factory method for creating enum from input\n- Use range matching for cleaner logic\n- Document threshold values in comments\n\n## Requirements\n\n### Functional Requirements\n\n1. **Enum Type Safety**\n   - Description: All enums must use Int16 rawValue for Core Data storage\n   - Acceptance: Enum values correctly serialize/deserialize with Core Data\n\n2. **02:00 Sleep Boundary**\n   - Description: Activities between 00:00-01:59 count toward previous day for sleep tracking\n   - Acceptance: `DateUtils.getLogicalDate(Date(\"2024-01-02 01:30\"))` returns 2024-01-01\n\n3. **SleepStatus Auto-Determination**\n   - Description: Sleep status automatically determined from duration in minutes\n   - Acceptance: `SleepStatus.from(durationMinutes: 400)` returns `.good`\n\n4. **Validation Service**\n   - Description: Centralized validation for all user inputs\n   - Acceptance: ValidationService correctly validates:\n     - Height: 100-250cm\n     - Weight: 20-300kg\n     - Body fat %: 3-60%\n     - Name: 1-20 characters\n\n5. **Domain Entity Completeness**\n   - Description: All 9 domain entities match ERD specification\n   - Acceptance: Each entity contains all fields from docs/04_ERD.md\n\n6. **ActivityLevel Multipliers**\n   - Description: Each activity level provides correct TDEE multiplier\n   - Acceptance: Multipliers match: sedentary=1.2, light=1.375, moderate=1.55, active=1.725, veryActive=1.9\n\n7. **ExerciseType MET Values**\n   - Description: Each exercise type provides base MET value for calorie calculation\n   - Acceptance: MET values match docs/06_ALGORITHM.md specification\n\n### Edge Cases\n\n1. **Midnight Boundary** - Date at exactly 00:00:00 should be treated as previous day\n2. **02:00 Exact Boundary** - Date at exactly 02:00:00 should be treated as current day\n3. **Leap Year** - Age calculation handles leap years correctly\n4. **Decimal Precision** - Body measurements maintain proper decimal precision (1 decimal place for display)\n5. **Zero Sleep Duration** - 0 minutes sleep should return `.bad` status (\ubc24\uc0d8)\n6. **Maximum Sleep Duration** - Very long durations (>24 hours) should return `.oversleep`\n\n## Implementation Notes\n\n### DO\n- Follow the enum pattern with Int16 rawValue for all enums\n- Use `Decimal` type for body measurements (weight, height, body fat %) for precision\n- Implement comprehensive docstrings with examples (Korean language)\n- Use Constants for all magic numbers (sleep boundary = 2, validation ranges)\n- Create unit tests for critical business logic (DateUtils, ValidationService, SleepStatus)\n- Reference docs/04_ERD.md for exact field names and types\n\n### DON'T\n- Create repository or service layer (out of scope for this task)\n- Implement Core Data fetch/save operations (only entity definitions)\n- Use Float/Double for financial or measurement calculations\n- Hardcode validation ranges (use Constants)\n- Skip unit tests for DateUtils 02:00 boundary logic\n\n## Development Environment\n\n### Start Services\n\n```bash\n# Open project in Xcode\nopen Bodii.xcodeproj\n\n# Run tests from command line\nxcodebuild test -project Bodii.xcodeproj -scheme Bodii -destination 'platform=iOS Simulator,name=iPhone 15'\n```\n\n### Service URLs\n- N/A (Native iOS application)\n\n### Required Environment Variables\n- None required for this foundation task\n\n## Success Criteria\n\nThe task is complete when:\n\n1. [ ] All 10 enums defined with Int16 rawValue and displayName\n2. [ ] DateUtils implements 02:00 sleep boundary correctly\n3. [ ] ValidationService validates all input ranges per docs/08_EDGE_CASES.md\n4. [ ] All 9 domain entities defined matching docs/04_ERD.md\n5. [ ] Unit tests pass for DateUtils, ValidationService, SleepStatus\n6. [ ] No Xcode build errors or warnings\n7. [ ] Code follows existing patterns (docstrings, MARK comments)\n\n## QA Acceptance Criteria\n\n**CRITICAL**: These criteria must be verified by the QA Agent before sign-off.\n\n### Unit Tests\n| Test | File | What to Verify |\n|------|------|----------------|\n| DateUtils Sleep Boundary | `BodiiTests/DateUtilsTests.swift` | 01:59 returns previous day, 02:00 returns current day |\n| DateUtils Edge Cases | `BodiiTests/DateUtilsTests.swift` | Midnight (00:00), end of day (23:59), leap years |\n| ValidationService Height | `BodiiTests/ValidationServiceTests.swift` | Valid 100-250cm, invalid <100 or >250 |\n| ValidationService Weight | `BodiiTests/ValidationServiceTests.swift` | Valid 20-300kg, invalid <20 or >300 |\n| ValidationService BodyFat | `BodiiTests/ValidationServiceTests.swift` | Valid 3-60%, invalid <3 or >60 |\n| ValidationService Name | `BodiiTests/ValidationServiceTests.swift` | Valid 1-20 chars, invalid empty or >20 |\n| SleepStatus Factory | `BodiiTests/SleepStatusTests.swift` | All duration ranges map to correct status |\n| SleepStatus Zero | `BodiiTests/SleepStatusTests.swift` | 0 minutes returns .bad |\n| SleepStatus Boundaries | `BodiiTests/SleepStatusTests.swift` | 329->bad, 330->soso, 389->soso, 390->good, etc. |\n\n### Integration Tests\n| Test | Services | What to Verify |\n|------|----------|----------------|\n| Domain Entity Serialization | Domain \u2194 Codable | All entities encode/decode correctly via Codable |\n| Enum Raw Value Mapping | Enums \u2194 Int16 | All enums convert to/from Int16 correctly |\n\n### End-to-End Tests\n| Flow | Steps | Expected Outcome |\n|------|-------|------------------|\n| Type System Completeness | 1. Review all enums 2. Check rawValue types | All 10 enums have Int16 rawValue |\n| Domain Model Completeness | 1. Compare entities to ERD 2. Verify all fields | All 9 entities match docs/04_ERD.md |\n\n### Browser Verification (if frontend)\n| Page/Component | URL | Checks |\n|----------------|-----|--------|\n| N/A | N/A | No UI in this task - foundation layer only |\n\n### Database Verification (if applicable)\n| Check | Query/Command | Expected |\n|-------|---------------|----------|\n| Core Data Model | Open Bodii.xcdatamodeld in Xcode | All entities defined with correct attributes |\n| Entity Attributes | Inspect each entity | Fields match docs/04_ERD.md types |\n\n### QA Sign-off Requirements\n- [ ] All unit tests pass\n- [ ] All integration tests pass\n- [ ] All E2E tests pass\n- [ ] Xcode builds without errors or warnings\n- [ ] Code follows established patterns (MARK comments, docstrings)\n- [ ] No regressions in existing functionality\n- [ ] Documentation inline with code (Korean language)\n- [ ] Critical 02:00 sleep boundary logic verified\n\n## Implementation Order\n\nThe recommended implementation sequence based on dependencies:\n\n1. **Phase 1: Constants & Enums** (no dependencies)\n   - Constants.swift\n   - Gender, ActivityLevel, MealType, ExerciseType, Intensity, FoodSource, GoalType, SleepStatus, QuantityUnit\n\n2. **Phase 2: Extensions** (depends on enums)\n   - Date+Extensions.swift\n   - Decimal+Extensions.swift\n\n3. **Phase 3: Utilities** (depends on Constants, Extensions)\n   - DateUtils.swift\n   - ValidationService.swift\n   - Formatters.swift\n\n4. **Phase 4: Domain Entities** (depends on Enums, Utilities)\n   - User, BodyRecord, MetabolismSnapshot\n   - Food, FoodRecord\n   - ExerciseRecord, SleepRecord\n   - DailyLog, Goal\n\n5. **Phase 5: Core Data Model** (depends on Domain Entities)\n   - Bodii.xcdatamodeld entities\n\n6. **Phase 6: Unit Tests** (parallel with implementation)\n   - DateUtilsTests.swift\n   - ValidationServiceTests.swift\n   - SleepStatusTests.swift\n\n## Critical Business Rules Reference\n\n### Sleep Boundary (02:00)\n```\n00:00 ~ 01:59 \u2192 Previous day (for sleep tracking)\n02:00 ~ 23:59 \u2192 Current day\n```\n\n### Sleep Status Thresholds (minutes)\n```\n< 330 (< 5.5h)     \u2192 Bad \ud83d\udd34\n330-389 (5.5-6.5h) \u2192 Soso \ud83d\udfe1\n390-449 (6.5-7.5h) \u2192 Good \ud83d\udfe2\n450-540 (7.5-9h)   \u2192 Excellent \ud83d\udd35\n> 540 (> 9h)       \u2192 Oversleep \ud83d\udfe0\n```\n\n### Activity Level Multipliers\n```\n1: Sedentary    \u2192 1.2\n2: Light        \u2192 1.375\n3: Moderate     \u2192 1.55\n4: Active       \u2192 1.725\n5: Very Active  \u2192 1.9\n```\n\n### BMR Formulas\n```\nWith body fat %: Katch-McArdle\n  LBM = weight \u00d7 (1 - bodyFatPct/100)\n  BMR = 370 + (21.6 \u00d7 LBM)\n\nWithout body fat %: Mifflin-St Jeor\n  Male: BMR = 10 \u00d7 weight + 6.25 \u00d7 height - 5 \u00d7 age + 5\n  Female: BMR = 10 \u00d7 weight + 6.25 \u00d7 height - 5 \u00d7 age - 161\n```\n",
        "last_modified": "2026-01-14T22:57:13.072240"
      },
      "task_intent": {
        "title": "004-project-foundation-core-data-model",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-12T11:36:12.377552",
  "last_updated": "2026-01-12T19:14:54.902985"
}