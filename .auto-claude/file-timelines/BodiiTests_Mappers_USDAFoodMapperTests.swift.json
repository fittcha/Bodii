{
  "file_path": "BodiiTests/Mappers/USDAFoodMapperTests.swift",
  "main_branch_history": [],
  "task_views": {
    "005-korean-food-database-integration": {
      "task_id": "005-korean-food-database-integration",
      "branch_point": {
        "commit_hash": "c44bfbcd7c1699b176a8bb155e8c35f43ebd4ad9",
        "content": "",
        "timestamp": "2026-01-13T07:46:23.878686"
      },
      "worktree_state": {
        "content": "//\n//  USDAFoodMapperTests.swift\n//  BodiiTests\n//\n//  Created by Auto-Claude on 2026-01-13.\n//\n\nimport XCTest\n@testable import Bodii\n\n/// Unit tests for USDAFoodMapper DTO to Food entity mapping\n///\n/// USDAFoodMapper\uc758 DTO \u2192 Food \uc5d4\ud2f0\ud2f0 \ub9e4\ud551 \ub2e8\uc704 \ud14c\uc2a4\ud2b8\nfinal class USDAFoodMapperTests: XCTestCase {\n\n    // MARK: - Properties\n\n    var mapper: USDAFoodMapper!\n\n    // MARK: - Setup & Teardown\n\n    override func setUp() {\n        super.setUp()\n        mapper = USDAFoodMapper()\n    }\n\n    override func tearDown() {\n        mapper = nil\n        super.tearDown()\n    }\n\n    // MARK: - Successful Mapping Tests\n\n    /// Test: Valid USDA DTO with all nutrients maps to Food entity successfully\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ubaa8\ub4e0 \uc601\uc591\uc18c\uac00 \uc788\ub294 \uc720\ud6a8\ud55c USDA DTO\uac00 Food \uc5d4\ud2f0\ud2f0\ub85c \uc131\uacf5\uc801\uc73c\ub85c \ubcc0\ud658\ub428\n    func testToDomain_ValidDTOWithAllNutrients_ReturnsFood() throws {\n        // Given: Valid USDA DTO with complete nutrient array\n        let nutrients = [\n            USDANutrientDTO(\n                nutrientId: 1008,\n                nutrientName: \"Energy\",\n                nutrientNumber: \"208\",\n                value: 52.0,\n                unitName: \"kcal\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            ),\n            USDANutrientDTO(\n                nutrientId: 1005,\n                nutrientName: \"Carbohydrate, by difference\",\n                nutrientNumber: \"205\",\n                value: 13.8,\n                unitName: \"g\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            ),\n            USDANutrientDTO(\n                nutrientId: 1003,\n                nutrientName: \"Protein\",\n                nutrientNumber: \"203\",\n                value: 0.3,\n                unitName: \"g\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            ),\n            USDANutrientDTO(\n                nutrientId: 1004,\n                nutrientName: \"Total lipid (fat)\",\n                nutrientNumber: \"204\",\n                value: 0.2,\n                unitName: \"g\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            ),\n            USDANutrientDTO(\n                nutrientId: 1093,\n                nutrientName: \"Sodium, Na\",\n                nutrientNumber: \"307\",\n                value: 1.0,\n                unitName: \"mg\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            ),\n            USDANutrientDTO(\n                nutrientId: 1079,\n                nutrientName: \"Fiber, total dietary\",\n                nutrientNumber: \"291\",\n                value: 2.4,\n                unitName: \"g\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            ),\n            USDANutrientDTO(\n                nutrientId: 2000,\n                nutrientName: \"Total Sugars\",\n                nutrientNumber: \"269\",\n                value: 10.4,\n                unitName: \"g\",\n                derivationId: nil,\n                derivationCode: nil,\n                derivationDescription: nil\n            )\n        ]\n\n        let dto = USDAFoodDTO(\n            fdcId: 123456,\n            description: \"Apple, raw\",\n            dataType: \"Foundation\",\n            foodCode: nil,\n            publicationDate: \"2021-10-28\",\n            foodNutrients: nutrients,\n            servingSize: 100.0,\n            servingSizeUnit: \"g\",\n            householdServingFullText: \"1 medium apple\",\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: 9,\n            foodCategory: \"Fruits and Fruit Juices\"\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Should map all fields correctly\n        XCTAssertEqual(food.name, \"Apple, raw\", \"Name should match\")\n        XCTAssertEqual(food.calories, 52, \"Calories should match\")\n        XCTAssertEqual(food.carbohydrates, Decimal(13.8), \"Carbohydrates should match\")\n        XCTAssertEqual(food.protein, Decimal(0.3), \"Protein should match\")\n        XCTAssertEqual(food.fat, Decimal(0.2), \"Fat should match\")\n        XCTAssertEqual(food.sodium, Decimal(1.0), \"Sodium should match\")\n        XCTAssertEqual(food.fiber, Decimal(2.4), \"Fiber should match\")\n        XCTAssertEqual(food.sugar, Decimal(10.4), \"Sugar should match\")\n        XCTAssertEqual(food.servingSize, Decimal(100), \"Serving size should match\")\n        XCTAssertEqual(food.servingUnit, \"1 medium apple\", \"Serving unit should use householdServingFullText\")\n        XCTAssertEqual(food.source, .usda, \"Source should be usda\")\n        XCTAssertEqual(food.apiCode, \"123456\", \"API code should match fdcId\")\n        XCTAssertNil(food.createdByUserId, \"createdByUserId should be nil for API data\")\n    }\n\n    /// Test: DTO with minimum required nutrients (no optional fields)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ucd5c\uc18c \ud544\uc218 \uc601\uc591\uc18c\ub9cc \uc788\ub294 DTO (\uc120\ud0dd \ud544\ub4dc \uc5c6\uc74c)\n    func testToDomain_MinimumRequiredNutrients_ReturnsFood() throws {\n        // Given: DTO with only required nutrients\n        let nutrients = [\n            createNutrient(id: 1008, value: 100.0, name: \"Energy\"),      // calories\n            createNutrient(id: 1005, value: 20.0, name: \"Carbohydrate\"), // carbs\n            createNutrient(id: 1003, value: 5.0, name: \"Protein\"),       // protein\n            createNutrient(id: 1004, value: 3.0, name: \"Fat\")            // fat\n        ]\n\n        let dto = USDAFoodDTO(\n            fdcId: 789012,\n            description: \"Test Food\",\n            dataType: \"Foundation\",\n            foodCode: nil,\n            publicationDate: nil,\n            foodNutrients: nutrients,\n            servingSize: nil,\n            servingSizeUnit: nil,\n            householdServingFullText: nil,\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: nil,\n            foodCategory: nil\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Should map required fields and set defaults for optional\n        XCTAssertEqual(food.name, \"Test Food\", \"Name should match\")\n        XCTAssertEqual(food.calories, 100, \"Calories should match\")\n        XCTAssertEqual(food.carbohydrates, Decimal(20.0), \"Carbohydrates should match\")\n        XCTAssertEqual(food.protein, Decimal(5.0), \"Protein should match\")\n        XCTAssertEqual(food.fat, Decimal(3.0), \"Fat should match\")\n        XCTAssertNil(food.sodium, \"Sodium should be nil\")\n        XCTAssertNil(food.fiber, \"Fiber should be nil\")\n        XCTAssertNil(food.sugar, \"Sugar should be nil\")\n        XCTAssertEqual(food.servingSize, Decimal(100), \"Serving size should default to 100g\")\n        XCTAssertEqual(food.servingUnit, \"100g\", \"Serving unit should default to 100g\")\n    }\n\n    /// Test: Name trimming (removes leading/trailing whitespace)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc774\ub984 \uacf5\ubc31 \uc81c\uac70 (\uc55e\ub4a4 \uacf5\ubc31 \uc81c\uac70\ub428)\n    func testToDomain_NameWithWhitespace_TrimsWhitespace() throws {\n        // Given: DTO with whitespace in description\n        let nutrients = createCompleteNutrients()\n        let dto = createValidDTO(\n            fdcId: 111111,\n            description: \"  Milk, whole  \",\n            nutrients: nutrients\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Name should be trimmed\n        XCTAssertEqual(food.name, \"Milk, whole\", \"Name should be trimmed\")\n    }\n\n    /// Test: Decimal calorie values are rounded correctly\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc18c\uc218\uc810 \uce7c\ub85c\ub9ac \uac12\uc774 \uc62c\ubc14\ub974\uac8c \ubc18\uc62c\ub9bc\ub428\n    func testToDomain_DecimalCalories_Rounded() throws {\n        // Given: DTOs with decimal calorie values\n        let testCases: [(calories: Double, expected: Int32)] = [\n            (52.3, 52),\n            (52.5, 53),\n            (52.7, 53),\n            (99.9, 100)\n        ]\n\n        for testCase in testCases {\n            var nutrients = createCompleteNutrients()\n            // Replace energy nutrient with test value\n            nutrients.removeAll { $0.nutrientId == 1008 }\n            nutrients.append(createNutrient(id: 1008, value: testCase.calories, name: \"Energy\"))\n\n            let dto = createValidDTO(fdcId: 222222, description: \"Test\", nutrients: nutrients)\n\n            // When: Mapping to domain entity\n            let food = try mapper.toDomain(from: dto)\n\n            // Then: Calories should be rounded correctly\n            XCTAssertEqual(\n                food.calories,\n                testCase.expected,\n                \"Calories \\(testCase.calories) should round to \\(testCase.expected)\"\n            )\n        }\n    }\n\n    // MARK: - Unit Conversion Tests\n\n    /// Test: Serving size unit conversion (oz to g)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc81c\uacf5\ub7c9 \ub2e8\uc704 \ubcc0\ud658 (oz \u2192 g)\n    func testToDomain_ServingSizeInOunces_ConvertsToGrams() throws {\n        // Given: DTO with serving size in ounces\n        let nutrients = createCompleteNutrients()\n        let dto = USDAFoodDTO(\n            fdcId: 333333,\n            description: \"Test Food\",\n            dataType: \"Branded\",\n            foodCode: nil,\n            publicationDate: nil,\n            foodNutrients: nutrients,\n            servingSize: 3.5,\n            servingSizeUnit: \"oz\",\n            householdServingFullText: nil,\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: nil,\n            foodCategory: nil\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Serving size should be converted to grams (3.5 oz * 28.3495 = ~99.22g)\n        let expectedGrams = Decimal(3.5) * Decimal(28.3495)\n        XCTAssertEqual(\n            food.servingSize,\n            expectedGrams,\n            accuracy: Decimal(0.01),\n            \"3.5 oz should convert to ~99.22g\"\n        )\n    }\n\n    /// Test: Serving size unit conversion (lb to g)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc81c\uacf5\ub7c9 \ub2e8\uc704 \ubcc0\ud658 (lb \u2192 g)\n    func testToDomain_ServingSizeInPounds_ConvertsToGrams() throws {\n        // Given: DTO with serving size in pounds\n        let nutrients = createCompleteNutrients()\n        let dto = createValidDTO(\n            fdcId: 444444,\n            description: \"Test Food\",\n            nutrients: nutrients,\n            servingSize: 1.0,\n            servingUnit: \"lb\"\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Serving size should be converted to grams (1 lb = 453.592g)\n        XCTAssertEqual(\n            food.servingSize,\n            Decimal(453.592),\n            accuracy: Decimal(0.01),\n            \"1 lb should convert to 453.592g\"\n        )\n    }\n\n    /// Test: Serving size already in grams (no conversion)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc774\ubbf8 \uadf8\ub7a8\uc778 \uc81c\uacf5\ub7c9 (\ubcc0\ud658 \ubd88\ud544\uc694)\n    func testToDomain_ServingSizeInGrams_NoConversion() throws {\n        // Given: DTO with serving size in grams\n        let nutrients = createCompleteNutrients()\n        let dto = createValidDTO(\n            fdcId: 555555,\n            description: \"Test Food\",\n            nutrients: nutrients,\n            servingSize: 150.0,\n            servingUnit: \"g\"\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Serving size should remain as-is\n        XCTAssertEqual(food.servingSize, Decimal(150), \"Serving size should remain 150g\")\n    }\n\n    /// Test: Multiple unit conversions\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ub2e4\uc591\ud55c \ub2e8\uc704 \ubcc0\ud658\n    func testToDomain_VariousUnits_ConvertsCorrectly() throws {\n        // Given: Test cases for various unit conversions\n        let testCases: [(value: Double, unit: String, expectedGrams: Decimal)] = [\n            (100.0, \"g\", 100.0),\n            (1.0, \"kg\", 1000.0),\n            (500.0, \"mg\", 0.5),\n            (1.0, \"oz\", 28.3495),\n            (1.0, \"lb\", 453.592),\n            (236.588, \"ml\", 236.588), // water-based approximation\n            (1.0, \"cup\", 236.588)\n        ]\n\n        for testCase in testCases {\n            let nutrients = createCompleteNutrients()\n            let dto = createValidDTO(\n                fdcId: 666666,\n                description: \"Test\",\n                nutrients: nutrients,\n                servingSize: testCase.value,\n                servingUnit: testCase.unit\n            )\n\n            // When: Mapping to domain entity\n            let food = try mapper.toDomain(from: dto)\n\n            // Then: Should convert to grams correctly\n            XCTAssertEqual(\n                food.servingSize,\n                testCase.expectedGrams,\n                accuracy: Decimal(0.01),\n                \"\\(testCase.value) \\(testCase.unit) should convert to ~\\(testCase.expectedGrams)g\"\n            )\n        }\n    }\n\n    // MARK: - Serving Unit Tests\n\n    /// Test: Household serving text takes precedence over servingSizeUnit\n    ///\n    /// \ud14c\uc2a4\ud2b8: householdServingFullText\uac00 servingSizeUnit\ubcf4\ub2e4 \uc6b0\uc120\ud568\n    func testToDomain_HouseholdServingText_TakesPrecedence() throws {\n        // Given: DTO with both householdServingFullText and servingSizeUnit\n        let nutrients = createCompleteNutrients()\n        let dto = USDAFoodDTO(\n            fdcId: 777777,\n            description: \"Banana\",\n            dataType: \"Foundation\",\n            foodCode: nil,\n            publicationDate: nil,\n            foodNutrients: nutrients,\n            servingSize: 100.0,\n            servingSizeUnit: \"g\",\n            householdServingFullText: \"1 medium banana\",\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: nil,\n            foodCategory: nil\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Should use householdServingFullText\n        XCTAssertEqual(food.servingUnit, \"1 medium banana\", \"Should use household serving text\")\n    }\n\n    /// Test: Falls back to servingSizeUnit when no householdServingFullText\n    ///\n    /// \ud14c\uc2a4\ud2b8: householdServingFullText\uac00 \uc5c6\uc73c\uba74 servingSizeUnit \uc0ac\uc6a9\n    func testToDomain_NoHouseholdText_UsesServingSizeUnit() throws {\n        // Given: DTO with only servingSizeUnit\n        let nutrients = createCompleteNutrients()\n        let dto = createValidDTO(\n            fdcId: 888888,\n            description: \"Test\",\n            nutrients: nutrients,\n            servingSize: 100.0,\n            servingUnit: \"g\",\n            householdText: nil\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Should use servingSizeUnit\n        XCTAssertEqual(food.servingUnit, \"g\", \"Should use serving size unit\")\n    }\n\n    /// Test: Defaults to 100g when no serving unit provided\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc81c\uacf5\ub7c9 \ub2e8\uc704\uac00 \uc5c6\uc73c\uba74 100g\uc73c\ub85c \uae30\ubcf8\uac12 \uc124\uc815\n    func testToDomain_NoServingUnit_DefaultsTo100g() throws {\n        // Given: DTO with no serving unit information\n        let nutrients = createCompleteNutrients()\n        let dto = USDAFoodDTO(\n            fdcId: 999999,\n            description: \"Test\",\n            dataType: nil,\n            foodCode: nil,\n            publicationDate: nil,\n            foodNutrients: nutrients,\n            servingSize: nil,\n            servingSizeUnit: nil,\n            householdServingFullText: nil,\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: nil,\n            foodCategory: nil\n        )\n\n        // When: Mapping to domain entity\n        let food = try mapper.toDomain(from: dto)\n\n        // Then: Should default to 100g\n        XCTAssertEqual(food.servingUnit, \"100g\", \"Should default to 100g\")\n    }\n\n    // MARK: - Error Cases Tests\n\n    /// Test: Empty description throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ube48 \uc124\uba85 \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_EmptyDescription_ThrowsError() {\n        // Given: DTO with empty description\n        let nutrients = createCompleteNutrients()\n        let dto = createValidDTO(fdcId: 111, description: \"\", nutrients: nutrients)\n\n        // When/Then: Should throw missingRequiredField error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.missingRequiredField(let field) = error else {\n                XCTFail(\"Expected MappingError.missingRequiredField, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"description\", \"Error should indicate missing description\")\n        }\n    }\n\n    /// Test: Nil food nutrients throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: foodNutrients\uac00 nil\uc774\uba74 \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_NilFoodNutrients_ThrowsError() {\n        // Given: DTO with nil foodNutrients\n        let dto = USDAFoodDTO(\n            fdcId: 222,\n            description: \"Test Food\",\n            dataType: nil,\n            foodCode: nil,\n            publicationDate: nil,\n            foodNutrients: nil,\n            servingSize: nil,\n            servingSizeUnit: nil,\n            householdServingFullText: nil,\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: nil,\n            foodCategory: nil\n        )\n\n        // When/Then: Should throw missingRequiredField error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.missingRequiredField(let field) = error else {\n                XCTFail(\"Expected MappingError.missingRequiredField, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"foodNutrients\", \"Error should indicate missing foodNutrients\")\n        }\n    }\n\n    /// Test: Empty food nutrients array throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ube48 foodNutrients \ubc30\uc5f4 \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_EmptyFoodNutrients_ThrowsError() {\n        // Given: DTO with empty foodNutrients array\n        let dto = createValidDTO(fdcId: 333, description: \"Test\", nutrients: [])\n\n        // When/Then: Should throw missingRequiredField error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.missingRequiredField(let field) = error else {\n                XCTFail(\"Expected MappingError.missingRequiredField, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"foodNutrients\", \"Error should indicate missing foodNutrients\")\n        }\n    }\n\n    /// Test: Missing calories nutrient throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uce7c\ub85c\ub9ac \uc601\uc591\uc18c \ub204\ub77d \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_MissingCalories_ThrowsError() {\n        // Given: Nutrients without energy (ID 1008)\n        let nutrients = [\n            createNutrient(id: 1005, value: 20.0, name: \"Carbohydrate\"),\n            createNutrient(id: 1003, value: 5.0, name: \"Protein\"),\n            createNutrient(id: 1004, value: 3.0, name: \"Fat\")\n        ]\n        let dto = createValidDTO(fdcId: 444, description: \"Test\", nutrients: nutrients)\n\n        // When/Then: Should throw invalidNutritionData error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.invalidNutritionData(let field) = error else {\n                XCTFail(\"Expected MappingError.invalidNutritionData, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"energy (1008)\", \"Error should indicate missing energy\")\n        }\n    }\n\n    /// Test: Missing carbohydrates nutrient throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ud0c4\uc218\ud654\ubb3c \uc601\uc591\uc18c \ub204\ub77d \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_MissingCarbohydrates_ThrowsError() {\n        // Given: Nutrients without carbohydrates (ID 1005)\n        let nutrients = [\n            createNutrient(id: 1008, value: 100.0, name: \"Energy\"),\n            createNutrient(id: 1003, value: 5.0, name: \"Protein\"),\n            createNutrient(id: 1004, value: 3.0, name: \"Fat\")\n        ]\n        let dto = createValidDTO(fdcId: 555, description: \"Test\", nutrients: nutrients)\n\n        // When/Then: Should throw invalidNutritionData error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.invalidNutritionData(let field) = error else {\n                XCTFail(\"Expected MappingError.invalidNutritionData, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"carbohydrate (1005)\", \"Error should indicate missing carbohydrate\")\n        }\n    }\n\n    /// Test: Missing protein nutrient throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ub2e8\ubc31\uc9c8 \uc601\uc591\uc18c \ub204\ub77d \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_MissingProtein_ThrowsError() {\n        // Given: Nutrients without protein (ID 1003)\n        let nutrients = [\n            createNutrient(id: 1008, value: 100.0, name: \"Energy\"),\n            createNutrient(id: 1005, value: 20.0, name: \"Carbohydrate\"),\n            createNutrient(id: 1004, value: 3.0, name: \"Fat\")\n        ]\n        let dto = createValidDTO(fdcId: 666, description: \"Test\", nutrients: nutrients)\n\n        // When/Then: Should throw invalidNutritionData error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.invalidNutritionData(let field) = error else {\n                XCTFail(\"Expected MappingError.invalidNutritionData, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"protein (1003)\", \"Error should indicate missing protein\")\n        }\n    }\n\n    /// Test: Missing fat nutrient throws error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc9c0\ubc29 \uc601\uc591\uc18c \ub204\ub77d \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_MissingFat_ThrowsError() {\n        // Given: Nutrients without fat (ID 1004)\n        let nutrients = [\n            createNutrient(id: 1008, value: 100.0, name: \"Energy\"),\n            createNutrient(id: 1005, value: 20.0, name: \"Carbohydrate\"),\n            createNutrient(id: 1003, value: 5.0, name: \"Protein\")\n        ]\n        let dto = createValidDTO(fdcId: 777, description: \"Test\", nutrients: nutrients)\n\n        // When/Then: Should throw invalidNutritionData error\n        XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n            guard case MappingError.invalidNutritionData(let field) = error else {\n                XCTFail(\"Expected MappingError.invalidNutritionData, got \\(error)\")\n                return\n            }\n            XCTAssertEqual(field, \"fat (1004)\", \"Error should indicate missing fat\")\n        }\n    }\n\n    /// Test: Negative nutrient values throw error\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc74c\uc218 \uc601\uc591\uc18c \uac12 \uc2dc \uc5d0\ub7ec \ubc1c\uc0dd\n    func testToDomain_NegativeNutrients_ThrowsError() {\n        // Given: Nutrients with negative values\n        let testCases: [(id: Int, name: String, field: String)] = [\n            (1008, \"Energy\", \"energy (1008)\"),\n            (1005, \"Carbohydrate\", \"carbohydrate (1005)\"),\n            (1003, \"Protein\", \"protein (1003)\"),\n            (1004, \"Fat\", \"fat (1004)\")\n        ]\n\n        for testCase in testCases {\n            var nutrients = createCompleteNutrients()\n            nutrients.removeAll { $0.nutrientId == testCase.id }\n            nutrients.append(createNutrient(id: testCase.id, value: -10.0, name: testCase.name))\n\n            let dto = createValidDTO(fdcId: 888, description: \"Test\", nutrients: nutrients)\n\n            // When/Then: Should throw invalidNutritionData error\n            XCTAssertThrowsError(try mapper.toDomain(from: dto)) { error in\n                guard case MappingError.invalidNutritionData(let field) = error else {\n                    XCTFail(\"Expected MappingError.invalidNutritionData for \\(testCase.name), got \\(error)\")\n                    return\n                }\n                XCTAssertEqual(field, testCase.field, \"Error should indicate invalid \\(testCase.name)\")\n            }\n        }\n    }\n\n    // MARK: - Batch Mapping Tests\n\n    /// Test: Batch mapping with all valid DTOs\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ubaa8\ub450 \uc720\ud6a8\ud55c DTO\uc758 \ubc30\uce58 \ub9e4\ud551\n    func testToDomainArray_AllValid_ReturnsAllFoods() {\n        // Given: Array of valid DTOs\n        let nutrients = createCompleteNutrients()\n        let dtos = [\n            createValidDTO(fdcId: 1, description: \"Apple\", nutrients: nutrients),\n            createValidDTO(fdcId: 2, description: \"Banana\", nutrients: nutrients),\n            createValidDTO(fdcId: 3, description: \"Orange\", nutrients: nutrients)\n        ]\n\n        // When: Batch mapping to domain entities\n        let foods = mapper.toDomainArray(from: dtos)\n\n        // Then: All DTOs should be mapped\n        XCTAssertEqual(foods.count, 3, \"Should map all 3 DTOs\")\n        XCTAssertEqual(foods[0].name, \"Apple\", \"First food should be Apple\")\n        XCTAssertEqual(foods[1].name, \"Banana\", \"Second food should be Banana\")\n        XCTAssertEqual(foods[2].name, \"Orange\", \"Third food should be Orange\")\n    }\n\n    /// Test: Batch mapping with some invalid DTOs (filters out failures)\n    ///\n    /// \ud14c\uc2a4\ud2b8: \uc77c\ubd80 \ubb34\ud6a8\ud55c DTO\uc758 \ubc30\uce58 \ub9e4\ud551 (\uc2e4\ud328\ud55c \uac83\uc740 \uc81c\uc678\ub428)\n    func testToDomainArray_SomeInvalid_FiltersOutInvalid() {\n        // Given: Array with mix of valid and invalid DTOs\n        let validNutrients = createCompleteNutrients()\n        let invalidNutrients = [createNutrient(id: 1008, value: 100.0, name: \"Energy\")] // Missing required nutrients\n\n        let dtos = [\n            createValidDTO(fdcId: 1, description: \"Apple\", nutrients: validNutrients),\n            createValidDTO(fdcId: 2, description: \"\", nutrients: validNutrients), // Invalid: empty description\n            createValidDTO(fdcId: 3, description: \"Banana\", nutrients: validNutrients),\n            createValidDTO(fdcId: 4, description: \"Invalid\", nutrients: invalidNutrients), // Invalid: missing nutrients\n            createValidDTO(fdcId: 5, description: \"Orange\", nutrients: validNutrients)\n        ]\n\n        // When: Batch mapping to domain entities\n        let foods = mapper.toDomainArray(from: dtos)\n\n        // Then: Only valid DTOs should be mapped\n        XCTAssertEqual(foods.count, 3, \"Should map only 3 valid DTOs\")\n        XCTAssertEqual(foods[0].name, \"Apple\", \"First food should be Apple\")\n        XCTAssertEqual(foods[1].name, \"Banana\", \"Second food should be Banana\")\n        XCTAssertEqual(foods[2].name, \"Orange\", \"Third food should be Orange\")\n    }\n\n    /// Test: Batch mapping with all invalid DTOs returns empty array\n    ///\n    /// \ud14c\uc2a4\ud2b8: \ubaa8\ub450 \ubb34\ud6a8\ud55c DTO\uc758 \ubc30\uce58 \ub9e4\ud551 \uc2dc \ube48 \ubc30\uc5f4 \ubc18\ud658\n    func testToDomainArray_AllInvalid_ReturnsEmptyArray() {\n        // Given: Array of all invalid DTOs\n        let incompleteNutrients = [createNutrient(id: 1008, value: 100.0, name: \"Energy\")]\n        let dtos = [\n            createValidDTO(fdcId: 1, description: \"\", nutrients: incompleteNutrients),\n            createValidDTO(fdcId: 2, description: \"Test\", nutrients: []),\n            createValidDTO(fdcId: 3, description: \"Test\", nutrients: incompleteNutrients)\n        ]\n\n        // When: Batch mapping to domain entities\n        let foods = mapper.toDomainArray(from: dtos)\n\n        // Then: Should return empty array\n        XCTAssertEqual(foods.count, 0, \"Should return empty array for all invalid DTOs\")\n    }\n\n    // MARK: - Helper Methods\n\n    /// Create a complete set of nutrients for testing\n    private func createCompleteNutrients() -> [USDANutrientDTO] {\n        return [\n            createNutrient(id: 1008, value: 100.0, name: \"Energy\"),\n            createNutrient(id: 1005, value: 20.0, name: \"Carbohydrate\"),\n            createNutrient(id: 1003, value: 5.0, name: \"Protein\"),\n            createNutrient(id: 1004, value: 3.0, name: \"Fat\"),\n            createNutrient(id: 1093, value: 10.0, name: \"Sodium\"),\n            createNutrient(id: 1079, value: 2.0, name: \"Fiber\"),\n            createNutrient(id: 2000, value: 5.0, name: \"Sugars\")\n        ]\n    }\n\n    /// Create a nutrient DTO for testing\n    private func createNutrient(\n        id: Int,\n        value: Double,\n        name: String\n    ) -> USDANutrientDTO {\n        return USDANutrientDTO(\n            nutrientId: id,\n            nutrientName: name,\n            nutrientNumber: \"\\(id)\",\n            value: value,\n            unitName: id == 1008 ? \"kcal\" : (id == 1093 ? \"mg\" : \"g\"),\n            derivationId: nil,\n            derivationCode: nil,\n            derivationDescription: nil\n        )\n    }\n\n    /// Create a valid DTO for testing\n    private func createValidDTO(\n        fdcId: Int,\n        description: String,\n        nutrients: [USDANutrientDTO],\n        servingSize: Double = 100.0,\n        servingUnit: String = \"g\",\n        householdText: String? = nil\n    ) -> USDAFoodDTO {\n        return USDAFoodDTO(\n            fdcId: fdcId,\n            description: description,\n            dataType: \"Foundation\",\n            foodCode: nil,\n            publicationDate: nil,\n            foodNutrients: nutrients,\n            servingSize: servingSize,\n            servingSizeUnit: servingUnit,\n            householdServingFullText: householdText,\n            brandOwner: nil,\n            brandName: nil,\n            gtinUpc: nil,\n            ingredients: nil,\n            foodCategoryId: nil,\n            foodCategory: nil\n        )\n    }\n}\n",
        "last_modified": "2026-01-14T22:55:39.269308"
      },
      "task_intent": {
        "title": "005-korean-food-database-integration",
        "description": "Integrate Korean Food & Drug Administration (\uc2dd\uc57d\ucc98) food nutrition database API as primary source, with USDA FoodData Central as fallback for international foods. Prioritize Korean dishes (kimchi jjigae, bibimbap, tteokbokki) that are poorly covered by competitors.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-13T07:43:31.865391",
  "last_updated": "2026-01-13T07:46:24.156233"
}