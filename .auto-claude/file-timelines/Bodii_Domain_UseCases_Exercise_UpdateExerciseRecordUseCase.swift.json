{
  "file_path": "Bodii/Domain/UseCases/Exercise/UpdateExerciseRecordUseCase.swift",
  "main_branch_history": [],
  "task_views": {
    "008-exercise-tracking-with-met-calculations": {
      "task_id": "008-exercise-tracking-with-met-calculations",
      "branch_point": {
        "commit_hash": "4e56d606f7b0d4cb74120dd392544f3fe2d4f5b4",
        "content": "",
        "timestamp": "2026-01-14T11:45:41.765455"
      },
      "worktree_state": {
        "content": "//\n//  UpdateExerciseRecordUseCase.swift\n//  Bodii\n//\n//  Created by Auto-Claude on 2026-01-14.\n//\n\nimport Foundation\n\n/// \uc6b4\ub3d9 \uae30\ub85d \uc218\uc815 \uc720\uc2a4\ucf00\uc774\uc2a4\n///\n/// \uae30\uc874 \uc6b4\ub3d9 \uae30\ub85d\uc744 \uc218\uc815\ud558\uace0, \uce7c\ub85c\ub9ac\ub97c \uc7ac\uacc4\uc0b0\ud558\uc5ec DailyLog\ub97c \uc5c5\ub370\uc774\ud2b8\ud569\ub2c8\ub2e4.\n///\n/// ## \ucc45\uc784\n/// - \uc6b4\ub3d9 \uae30\ub85d \uc870\ud68c (ID\ub85c)\n/// - \uc6b4\ub3d9 \uc785\ub825\uac12 \uac80\uc99d (duration \ucd5c\uc18c 1\ubd84)\n/// - \ubcc0\uacbd\uc0ac\ud56d\uc774 \uc788\uc744 \uacbd\uc6b0 \uce7c\ub85c\ub9ac \uc7ac\uacc4\uc0b0\n/// - ExerciseRecord \uc5c5\ub370\uc774\ud2b8 \ubc0f \uc800\uc7a5\n/// - DailyLog \uc5c5\ub370\uc774\ud2b8 (\ucc28\uc774\uac12\ub9cc\ud07c \uc870\uc815)\n///\n/// ## \uc758\uc874\uc131\n/// - ExerciseRecordRepository: \uc6b4\ub3d9 \uae30\ub85d \uc870\ud68c \ubc0f \uc5c5\ub370\uc774\ud2b8\n/// - DailyLogService: DailyLog \uc5c5\ub370\uc774\ud2b8\n///\n/// ## \uc0ac\uc6a9 \uc2dc\ub098\ub9ac\uc624\n/// ```swift\n/// let useCase = UpdateExerciseRecordUseCase(\n///     exerciseRepository: exerciseRepository,\n///     dailyLogService: dailyLogService\n/// )\n///\n/// let updatedRecord = try await useCase.execute(\n///     recordId: existingRecord.id,\n///     userId: userId,\n///     exerciseType: .cycling,\n///     duration: 45,\n///     intensity: .medium,\n///     note: \"\uc810\uc2ec \uc790\uc804\uac70 \ub77c\uc774\ub529\",\n///     userWeight: user.currentWeight ?? 70.0\n/// )\n/// ```\n///\n/// ## \uc5d0\ub7ec \ucf00\uc774\uc2a4\n/// - recordId\uc5d0 \ud574\ub2f9\ud558\ub294 \uae30\ub85d\uc774 \uc5c6\uc74c: RecordNotFoundError\n/// - duration < 1\ubd84: ValidationError\n/// - userId \ubd88\uc77c\uce58: UnauthorizedError\nfinal class UpdateExerciseRecordUseCase {\n\n    // MARK: - Properties\n\n    /// \uc6b4\ub3d9 \uae30\ub85d \uc800\uc7a5\uc18c\n    private let exerciseRepository: ExerciseRecordRepository\n\n    /// DailyLog \uad00\ub9ac \uc11c\ube44\uc2a4\n    private let dailyLogService: DailyLogService\n\n    // MARK: - Initialization\n\n    /// UpdateExerciseRecordUseCase \ucd08\uae30\ud654\n    ///\n    /// - Parameters:\n    ///   - exerciseRepository: \uc6b4\ub3d9 \uae30\ub85d \uc800\uc7a5\uc18c\n    ///   - dailyLogService: DailyLog \uad00\ub9ac \uc11c\ube44\uc2a4\n    init(\n        exerciseRepository: ExerciseRecordRepository,\n        dailyLogService: DailyLogService\n    ) {\n        self.exerciseRepository = exerciseRepository\n        self.dailyLogService = dailyLogService\n    }\n\n    // MARK: - Public Methods\n\n    /// \uae30\uc874 \uc6b4\ub3d9 \uae30\ub85d\uc744 \uc218\uc815\ud569\ub2c8\ub2e4.\n    ///\n    /// ## \uc2e4\ud589 \uc21c\uc11c\n    /// 1. \uae30\uc874 \uc6b4\ub3d9 \uae30\ub85d \uc870\ud68c (ID\ub85c)\n    /// 2. \uad8c\ud55c \ud655\uc778 (userId \uc77c\uce58 \uc5ec\ubd80)\n    /// 3. \uc785\ub825\uac12 \uac80\uc99d (duration \u2265 1\ubd84)\n    /// 4. \ubcc0\uacbd\uc0ac\ud56d \ud655\uc778 \ubc0f \uce7c\ub85c\ub9ac \uc7ac\uacc4\uc0b0 (type, duration, intensity \ubcc0\uacbd \uc2dc)\n    /// 5. ExerciseRecord \uc5c5\ub370\uc774\ud2b8\n    /// 6. DailyLogService\ub97c \ud1b5\ud574 DailyLog \uc870\uc815 (\ucc28\uc774\uac12\ub9cc\ud07c)\n    ///\n    /// - Parameters:\n    ///   - recordId: \uc218\uc815\ud560 \uc6b4\ub3d9 \uae30\ub85d ID\n    ///   - userId: \uc0ac\uc6a9\uc790 ID\n    ///   - exerciseType: \uc6b4\ub3d9 \uc885\ub958\n    ///   - duration: \uc6b4\ub3d9 \uc2dc\uac04 (\ubd84)\n    ///   - intensity: \uc6b4\ub3d9 \uac15\ub3c4\n    ///   - note: \uba54\ubaa8 (\uc120\ud0dd\uc0ac\ud56d)\n    ///   - userWeight: \uc0ac\uc6a9\uc790 \uccb4\uc911 (kg) - MET \uacc4\uc0b0\uc5d0 \uc0ac\uc6a9\n    ///\n    /// - Throws:\n    ///   - RecordNotFoundError: \uc6b4\ub3d9 \uae30\ub85d\uc744 \ucc3e\uc744 \uc218 \uc5c6\uc744 \ub54c\n    ///   - UnauthorizedError: userId\uac00 \uc77c\uce58\ud558\uc9c0 \uc54a\uc744 \ub54c\n    ///   - ValidationError: \uc785\ub825\uac12\uc774 \uc720\ud6a8\ud558\uc9c0 \uc54a\uc744 \ub54c\n    ///   - RepositoryError: \uc800\uc7a5 \uc2e4\ud328 \uc2dc\n    ///\n    /// - Returns: \uc218\uc815\ub41c ExerciseRecord\n    ///\n    /// - Example:\n    /// ```swift\n    /// do {\n    ///     let updatedRecord = try await useCase.execute(\n    ///         recordId: record.id,\n    ///         userId: user.id,\n    ///         exerciseType: .running,\n    ///         duration: 45,  // 30\ubd84 \u2192 45\ubd84\uc73c\ub85c \ubcc0\uacbd\n    ///         intensity: .high,\n    ///         note: \"\uc544\uce68 \uc870\uae45 (\uc5f0\uc7a5)\",\n    ///         userWeight: user.currentWeight ?? 70.0\n    ///     )\n    ///     print(\"\uc6b4\ub3d9 \uae30\ub85d \uc218\uc815: \\(updatedRecord.caloriesBurned)kcal\")\n    /// } catch {\n    ///     print(\"\uc6b4\ub3d9 \uae30\ub85d \uc218\uc815 \uc2e4\ud328: \\(error)\")\n    /// }\n    /// ```\n    func execute(\n        recordId: UUID,\n        userId: UUID,\n        exerciseType: ExerciseType,\n        duration: Int32,\n        intensity: Intensity,\n        note: String? = nil,\n        userWeight: Decimal\n    ) async throws -> ExerciseRecord {\n        // 1. \uae30\uc874 \uc6b4\ub3d9 \uae30\ub85d \uc870\ud68c\n        guard let existingRecord = try await exerciseRepository.fetchById(recordId, userId: userId) else {\n            throw RecordNotFoundError.exerciseRecordNotFound(\"\uc6b4\ub3d9 \uae30\ub85d\uc744 \ucc3e\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.\")\n        }\n\n        // 2. \uad8c\ud55c \ud655\uc778\n        guard existingRecord.userId == userId else {\n            throw UnauthorizedError.notOwner(\"\ud574\ub2f9 \uc6b4\ub3d9 \uae30\ub85d\uc744 \uc218\uc815\ud560 \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.\")\n        }\n\n        // 3. \uc785\ub825\uac12 \uac80\uc99d\n        try validateInput(duration: duration)\n\n        // 4. \ubcc0\uacbd\uc0ac\ud56d \ud655\uc778 \ubc0f \uce7c\ub85c\ub9ac \uc7ac\uacc4\uc0b0\n        let needsRecalculation = hasCalorieAffectingChanges(\n            existingRecord: existingRecord,\n            newType: exerciseType,\n            newDuration: duration,\n            newIntensity: intensity\n        )\n\n        let newCalories: Int32\n        if needsRecalculation {\n            // \uce7c\ub85c\ub9ac \uc7ac\uacc4\uc0b0\n            newCalories = ExerciseCalcService.calculateCalories(\n                exerciseType: exerciseType,\n                duration: duration,\n                intensity: intensity,\n                weight: userWeight\n            )\n        } else {\n            // \ubcc0\uacbd\uc0ac\ud56d\uc774 \uc5c6\uc73c\uba74 \uae30\uc874 \uce7c\ub85c\ub9ac \uc720\uc9c0\n            newCalories = existingRecord.caloriesBurned\n        }\n\n        // 5. ExerciseRecord \uc5c5\ub370\uc774\ud2b8\n        let updatedRecord = ExerciseRecord(\n            id: existingRecord.id,\n            userId: existingRecord.userId,\n            date: existingRecord.date,\n            exerciseType: exerciseType,\n            duration: duration,\n            intensity: intensity,\n            caloriesBurned: newCalories,\n            createdAt: existingRecord.createdAt\n        )\n\n        let savedRecord = try await exerciseRepository.update(updatedRecord)\n\n        // 6. DailyLog \uc5c5\ub370\uc774\ud2b8 (\ucc28\uc774\uac12\ub9cc\ud07c \uc870\uc815)\n        try await dailyLogService.updateExercise(\n            date: savedRecord.date,\n            userId: userId,\n            oldCalories: existingRecord.caloriesBurned,\n            newCalories: savedRecord.caloriesBurned,\n            oldDuration: existingRecord.duration,\n            newDuration: savedRecord.duration\n        )\n\n        return savedRecord\n    }\n\n    // MARK: - Private Methods\n\n    /// \uc785\ub825\uac12\uc744 \uac80\uc99d\ud569\ub2c8\ub2e4.\n    ///\n    /// ## \uac80\uc99d \uaddc\uce59\n    /// - duration: \ucd5c\uc18c 1\ubd84 \uc774\uc0c1\n    ///\n    /// - Parameter duration: \uc6b4\ub3d9 \uc2dc\uac04 (\ubd84)\n    /// - Throws: ValidationError - \uac80\uc99d \uc2e4\ud328 \uc2dc\n    private func validateInput(duration: Int32) throws {\n        // \uc6b4\ub3d9 \uc2dc\uac04\uc740 \ucd5c\uc18c 1\ubd84 \uc774\uc0c1\n        guard duration >= 1 else {\n            throw ValidationError.invalidDuration(\"\ucd5c\uc18c 1\ubd84 \uc774\uc0c1 \uc785\ub825\ud574\uc8fc\uc138\uc694\")\n        }\n    }\n\n    /// \uce7c\ub85c\ub9ac \uc7ac\uacc4\uc0b0\uc774 \ud544\uc694\ud55c \ubcc0\uacbd\uc0ac\ud56d\uc774 \uc788\ub294\uc9c0 \ud655\uc778\ud569\ub2c8\ub2e4.\n    ///\n    /// \uc6b4\ub3d9 \uc885\ub958, \uc2dc\uac04, \uac15\ub3c4 \uc911 \ud558\ub098\ub77c\ub3c4 \ubcc0\uacbd\ub418\uc5c8\uc73c\uba74 true\ub97c \ubc18\ud658\ud569\ub2c8\ub2e4.\n    ///\n    /// - Parameters:\n    ///   - existingRecord: \uae30\uc874 \uc6b4\ub3d9 \uae30\ub85d\n    ///   - newType: \uc0c8\ub85c\uc6b4 \uc6b4\ub3d9 \uc885\ub958\n    ///   - newDuration: \uc0c8\ub85c\uc6b4 \uc6b4\ub3d9 \uc2dc\uac04\n    ///   - newIntensity: \uc0c8\ub85c\uc6b4 \uc6b4\ub3d9 \uac15\ub3c4\n    /// - Returns: \uc7ac\uacc4\uc0b0 \ud544\uc694 \uc5ec\ubd80\n    private func hasCalorieAffectingChanges(\n        existingRecord: ExerciseRecord,\n        newType: ExerciseType,\n        newDuration: Int32,\n        newIntensity: Intensity\n    ) -> Bool {\n        return existingRecord.exerciseType != newType ||\n               existingRecord.duration != newDuration ||\n               existingRecord.intensity != newIntensity\n    }\n}\n\n// MARK: - Error Types\n\n/// \uae30\ub85d \ubbf8\ubc1c\uacac \uc5d0\ub7ec\nenum RecordNotFoundError: LocalizedError {\n    case exerciseRecordNotFound(String)\n\n    var errorDescription: String? {\n        switch self {\n        case .exerciseRecordNotFound(let message):\n            return message\n        }\n    }\n}\n\n/// \uad8c\ud55c \uc5d0\ub7ec\nenum UnauthorizedError: LocalizedError {\n    case notOwner(String)\n\n    var errorDescription: String? {\n        switch self {\n        case .notOwner(let message):\n            return message\n        }\n    }\n}\n\n// MARK: - Update Pattern \uc124\uba85\n\n/// ## Update UseCase Pattern\n///\n/// Update UseCase\ub294 \uae30\uc874 \ub370\uc774\ud130\ub97c \uc218\uc815\ud560 \ub54c \ub2e4\uc74c \ud328\ud134\uc744 \ub530\ub985\ub2c8\ub2e4:\n///\n/// ### 1. \uae30\uc874 \ub370\uc774\ud130 \uc870\ud68c\n/// ```swift\n/// guard let existingRecord = try await repository.fetchById(id, userId: userId) else {\n///     throw RecordNotFoundError.exerciseRecordNotFound(\"...\")\n/// }\n/// ```\n///\n/// ### 2. \uad8c\ud55c \ud655\uc778\n/// ```swift\n/// guard existingRecord.userId == userId else {\n///     throw UnauthorizedError.notOwner(\"...\")\n/// }\n/// ```\n///\n/// ### 3. \uc785\ub825\uac12 \uac80\uc99d\n/// ```swift\n/// try validateInput(duration: duration)\n/// ```\n///\n/// ### 4. \ubcc0\uacbd\uc0ac\ud56d \ud655\uc778 \ubc0f \uc870\uac74\ubd80 \uc7ac\uacc4\uc0b0\n/// ```swift\n/// let needsRecalculation = hasCalorieAffectingChanges(...)\n/// if needsRecalculation {\n///     newCalories = ExerciseCalcService.calculateCalories(...)\n/// } else {\n///     newCalories = existingRecord.caloriesBurned\n/// }\n/// ```\n///\n/// ### 5. \uc5d4\ud2f0\ud2f0 \uc5c5\ub370\uc774\ud2b8\n/// ```swift\n/// let updatedRecord = ExerciseRecord(\n///     id: existingRecord.id,           // ID \uc720\uc9c0\n///     userId: existingRecord.userId,   // userId \uc720\uc9c0\n///     date: existingRecord.date,       // date \uc720\uc9c0\n///     exerciseType: newType,           // \uc0c8 \uac12\n///     duration: newDuration,           // \uc0c8 \uac12\n///     intensity: newIntensity,         // \uc0c8 \uac12\n///     caloriesBurned: newCalories,     // \uc7ac\uacc4\uc0b0\ub41c \uac12\n///     createdAt: existingRecord.createdAt  // createdAt \uc720\uc9c0\n/// )\n/// ```\n///\n/// ### 6. DailyLog \uc870\uc815 (\ucc28\uc774\uac12\ub9cc\ud07c)\n/// ```swift\n/// try await dailyLogService.updateExercise(\n///     date: savedRecord.date,\n///     userId: userId,\n///     oldCalories: existingRecord.caloriesBurned,  // \uc774\uc804 \uac12\n///     newCalories: savedRecord.caloriesBurned,     // \uc0c8 \uac12\n///     oldDuration: existingRecord.duration,        // \uc774\uc804 \uac12\n///     newDuration: savedRecord.duration            // \uc0c8 \uac12\n/// )\n/// ```\n///\n/// ### \uc65c \uc774\ub7f0 \ud328\ud134\uc744 \uc0ac\uc6a9\ud558\ub294\uac00?\n///\n/// 1. **\ub370\uc774\ud130 \uc77c\uad00\uc131**:\n///    - \uae30\uc874 \uae30\ub85d\uc744 \uba3c\uc800 \uc870\ud68c\ud558\uc5ec \uc874\uc7ac \uc5ec\ubd80 \ud655\uc778\n///    - \ubcc0\uacbd\ub418\uc9c0 \uc54a\uc544\uc57c \ud560 \ud544\ub4dc(id, userId, createdAt)\ub294 \uc720\uc9c0\n///\n/// 2. **\ubcf4\uc548**:\n///    - userId \ud655\uc778\uc73c\ub85c \ub2e4\ub978 \uc0ac\uc6a9\uc790\uc758 \uae30\ub85d \uc218\uc815 \ubc29\uc9c0\n///    - \uad8c\ud55c \uac80\uc99d\uc740 \ud544\uc218\n///\n/// 3. **\ud6a8\uc728\uc131**:\n///    - \uce7c\ub85c\ub9ac\uc5d0 \uc601\ud5a5\uc744 \uc8fc\uc9c0 \uc54a\ub294 \ubcc0\uacbd(\uc608: note\ub9cc \uc218\uc815)\uc740 \uc7ac\uacc4\uc0b0 \uc0dd\ub7b5\n///    - \ubd88\ud544\uc694\ud55c \uc5f0\uc0b0 \ubc29\uc9c0\n///\n/// 4. **\uc815\ud655\uc131**:\n///    - DailyLog\ub294 \ucc28\uc774\uac12\ub9cc\ud07c\ub9cc \uc870\uc815 (\uc804\uccb4 \uc7ac\uacc4\uc0b0 \ubd88\ud544\uc694)\n///    - \uc608: 300kcal \u2192 450kcal\ub85c \ubcc0\uacbd \uc2dc +150kcal\ub9cc \ucd94\uac00\n///\n/// 5. **\ud2b8\ub79c\uc7ad\uc158 \ubb34\uacb0\uc131**:\n///    - ExerciseRecord \uc5c5\ub370\uc774\ud2b8\uc640 DailyLog \uc870\uc815\uc744 \uc21c\ucc28\uc801\uc73c\ub85c \uc2e4\ud589\n///    - \ud558\ub098\ub77c\ub3c4 \uc2e4\ud328\ud558\uba74 \uc804\uccb4 \ub864\ubc31 (async/await\uc758 throw \uba54\ucee4\ub2c8\uc998)\n///\n/// ### \uc0ac\uc6a9 \uc608\uc2dc\n///\n/// ```swift\n/// // ViewModel\uc5d0\uc11c UpdateExerciseRecordUseCase \uc0ac\uc6a9\n/// final class ExerciseInputViewModel: ObservableObject {\n///     let updateExerciseUseCase: UpdateExerciseRecordUseCase\n///\n///     func updateExercise(recordId: UUID) async {\n///         do {\n///             let updated = try await updateExerciseUseCase.execute(\n///                 recordId: recordId,\n///                 userId: currentUser.id,\n///                 exerciseType: selectedType,\n///                 duration: duration,\n///                 intensity: intensity,\n///                 note: note,\n///                 userWeight: currentUser.currentWeight ?? 70.0\n///             )\n///             self.isSuccess = true\n///         } catch RecordNotFoundError.exerciseRecordNotFound {\n///             self.errorMessage = \"\uc6b4\ub3d9 \uae30\ub85d\uc744 \ucc3e\uc744 \uc218 \uc5c6\uc2b5\ub2c8\ub2e4.\"\n///         } catch UnauthorizedError.notOwner {\n///             self.errorMessage = \"\uc218\uc815 \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4.\"\n///         } catch ValidationError.invalidDuration {\n///             self.errorMessage = \"\uc6b4\ub3d9 \uc2dc\uac04\uc744 \ud655\uc778\ud574\uc8fc\uc138\uc694.\"\n///         } catch {\n///             self.errorMessage = \"\uc218\uc815 \uc2e4\ud328: \\(error.localizedDescription)\"\n///         }\n///     }\n/// }\n/// ```\n",
        "last_modified": "2026-01-14T22:54:09.702917"
      },
      "task_intent": {
        "title": "008-exercise-tracking-with-met-calculations",
        "description": "Exercise logging with activity type selection, duration input, and automatic calorie burn calculation using MET (Metabolic Equivalent of Task) values. Track both cardio and strength training with appropriate calculations.",
        "from_plan": true
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2026-01-13T19:19:06.198879",
  "last_updated": "2026-01-14T11:45:41.954429"
}