# Exercise Tracking with MET Calculations - Build Progress

## Feature Overview
Implement exercise logging with activity type selection, duration input, and automatic calorie burn calculation using MET (Metabolic Equivalent of Task) values.

---

## Implementation Plan Created: 2026-01-13

### Phases Overview

| Phase | Name | Subtasks | Status |
|-------|------|----------|--------|
| 1 | Core Services and Data Layer | 5 | Completed (5/5) |
| 2 | Use Cases and Business Logic | 4 | Pending |
| 3 | UI - Exercise List View | 4 | Pending |
| 4 | UI - Exercise Input Modal | 5 | Pending |
| 5 | Integration and Testing | 5 | Pending |

**Total Subtasks: 23 | Completed: 5 | In Progress: 0 | Pending: 18**

---

## Existing Infrastructure (Already Implemented)

- ExerciseRecord domain entity (Bodii/Domain/Entities/ExerciseRecord.swift)
- ExerciseType enum with baseMET values (Bodii/Shared/Enums/ExerciseType.swift)
- Intensity enum with metMultiplier (Bodii/Shared/Enums/Intensity.swift)
- DailyLog entity with exercise fields (totalCaloriesOut, exerciseMinutes, exerciseCount)
- User entity with currentWeight for MET calculations
- Core Data model for ExerciseRecord entity
- PersistenceController for Core Data operations
- Folder structure exists (Presentation/Features/Exercise/Views, ViewModels)
- ValidationService exists (can be extended)

---

## Key MET Calculation Formula

```
Calories Burned = MET x Weight(kg) x Duration(hours)
```

Intensity Multipliers:
- Low (저강도): 0.8
- Medium (중강도): 1.0
- High (고강도): 1.2

Example: Running 30 min, high intensity, 75kg
- Base MET for running: 8.0
- Adjusted MET: 8.0 x 1.2 = 9.6
- Calories: 9.6 x 75 x 0.5 = 360 kcal

---

## Progress Log

### 2026-01-13

**Planning & Discovery**
- [PLAN] Created detailed implementation plan with 5 phases, 23 subtasks
- [DISCOVERY] ExerciseType.baseMET and metValue(for:) already implemented
- [DISCOVERY] Intensity.metMultiplier already implemented
- [DISCOVERY] Core Data ExerciseRecord entity exists with all fields

**Phase 1: Core Services & Data Layer**
- ✅ [1.1] Implemented ExerciseCalcService with MET-based calorie calculation
  - Supports all 8 exercise types with correct MET values
  - Applies intensity multipliers (0.8, 1.0, 1.2)
  - Returns Int32 for calories burned
  - Includes overload for Decimal weight type

- ✅ [1.2] Created ExerciseRecordRepository protocol
  - Full CRUD operations: create, update, delete
  - Multiple read methods: fetchById, fetchByDate, fetchByDateRange, fetchAll
  - Utility methods: count, totalDuration, totalCaloriesBurned
  - Uses async/await pattern for modern Swift concurrency
  - Comprehensive documentation with usage examples
  - Located in: Bodii/Domain/Interfaces/ExerciseRecordRepository.swift

- ✅ [1.3] Created ExerciseRecordLocalDataSource
  - Core Data operations with async/await pattern
  - CRUD operations: create, update, delete
  - Multiple read methods with date filtering
  - Utility methods: count, totalDuration, totalCaloriesBurned
  - Thread-safe context.perform blocks
  - NSManagedObject ↔ Domain Entity mapping
  - Comprehensive Korean learning comments
  - Located in: Bodii/Data/DataSources/Local/ExerciseRecordLocalDataSource.swift

- ✅ [1.4] Implemented ExerciseRecordRepositoryImpl
  - Implements ExerciseRecordRepository protocol
  - Delegates all operations to ExerciseRecordLocalDataSource
  - Clean Architecture separation between domain and data layers
  - Comprehensive documentation with pattern explanations
  - Located in: Bodii/Data/Repositories/ExerciseRecordRepositoryImpl.swift

- ✅ [1.5] Created DailyLogService and infrastructure
  - **DailyLogRepository protocol**: getOrCreate, addExercise, removeExercise, updateExercise methods
  - **DailyLogLocalDataSource**: Core Data operations for DailyLog entity
    - Date normalization to startOfDay for consistency
    - Thread-safe async/await pattern
    - Automatic User relationship management
    - Exercise field increment/decrement with negative value protection
  - **DailyLogRepositoryImpl**: Clean Architecture implementation
  - **DailyLogService**: High-level service for DailyLog updates
    - getOrCreate with User.currentBMR/TDEE values
    - addExercise ensures DailyLog exists before updating
    - removeExercise decrements totalCaloriesOut, exerciseMinutes, exerciseCount
    - updateExercise applies difference calculation
    - Comprehensive documentation with usage examples
  - Files:
    - Bodii/Domain/Interfaces/DailyLogRepository.swift
    - Bodii/Data/DataSources/Local/DailyLogLocalDataSource.swift
    - Bodii/Data/Repositories/DailyLogRepositoryImpl.swift
    - Bodii/Domain/Services/DailyLogService.swift

---

## Next Steps
1. Phase 2: Build use cases for CRUD operations (AddExerciseRecordUseCase, UpdateExerciseRecordUseCase, etc.)
2. Phase 3: Implement Exercise List UI (ViewModel, Views, Components)
3. Phase 4: Implement Exercise Input Modal (ViewModel, Views, Components)
4. Phase 5: Integrate with DI container and write tests
