# Build Progress - 002 Project Foundation & Core Data Model

## Subtask 3.5: Create FoodRecord Domain Entity - âœ… COMPLETED

**Status:** COMPLETED
**File:** Bodii/Domain/Entities/FoodRecord.swift
**Commit:** 829cb63

### Implementation Details

All acceptance criteria have been met:

âœ… **FoodRecord struct with Identifiable, Codable, Equatable**
   - Identifiable: Uses UUID as id
   - Codable: All properties are Codable-conforming types
   - Equatable: Auto-synthesized by compiler

âœ… **All properties from ERD:**
   - id: UUID (unique identifier)
   - userId: UUID (foreign key to User)
   - foodId: UUID (foreign key to Food, N:1 relationship)
   - date: Date (ì„­ì·¨ ë‚ ì§œ, 02:00 sleep boundary logic)
   - mealType: MealType enum (breakfast/lunch/dinner/snack)
   - quantity: Decimal (ì„­ì·¨ëŸ‰)
   - quantityUnit: QuantityUnit enum (serving/gram)
   - createdAt: Date (creation timestamp)

âœ… **CalculatedNutrition nested struct**
   - calories: Int (ê³„ì‚°ëœ ì„­ì·¨ ì¹¼ë¡œë¦¬)
   - carbohydrates: Decimal (ê³„ì‚°ëœ íƒ„ìˆ˜í™”ë¬¼)
   - protein: Decimal (ê³„ì‚°ëœ ë‹¨ë°±ì§ˆ)
   - fat: Decimal (ê³„ì‚°ëœ ì§€ë°©)
   - sodium: Decimal? (ê³„ì‚°ëœ ë‚˜íŠ¸ë¥¨, optional)
   - fiber: Decimal? (ê³„ì‚°ëœ ì‹ì´ì„¬ìœ , optional)
   - sugar: Decimal? (ê³„ì‚°ëœ ë‹¹ë¥˜, optional)

âœ… **calculateNutrition(from:) method**
   - Takes Food parameter and calculates actual nutrition consumed
   - Formula: multiplier = quantity / Food.servingSize
   - Returns CalculatedNutrition with all values Ã— multiplier
   - Uses Decimal.rounded(scale:) for proper rounding

### Bonus Features

âœ… **Update methods for functional programming**
   - updatingQuantity(_:unit:) - Updates quantity and optionally unit
   - updatingMealType(_:) - Updates meal type classification

âœ… **CustomStringConvertible protocol**
   - Provides readable debug description
   - Shows all key properties in formatted output
   - Displays mealType and quantityUnit with Korean names

### Quality Attributes

âœ… Follows established patterns from Food and BodyRecord entities
âœ… Korean documentation with í•™ìŠµ í¬ì¸íŠ¸ (Transactional Record Pattern)
âœ… Comprehensive doc comments with calculation formulas
âœ… MARK organization for code sections
âœ… Domain entity pattern (separated from Core Data)
âœ… No console.log/print debugging statements
âœ… Functional update pattern (returns new instances)

### Documentation Highlights

**í•™ìŠµ í¬ì¸íŠ¸ (Learning Point):**
- Explains Transactional Record Pattern
- Compares to JPA @ManyToOne relationship (OrderItem - Product pattern)
- FoodRecord is transactional data that references Food master data

**Key Concepts:**
- N:1 relationship with Food (many records can reference same food)
- Aggregation into DailyLog for daily nutrition totals
- Meal type classification for pattern analysis
- Quantity-based nutrition calculation
- 02:00 sleep boundary for date assignment

**Calculation Formula:**
```
multiplier = quantity / Food.servingSize
ì„­ì·¨ ì¹¼ë¡œë¦¬ = Food.calories Ã— multiplier
ì„­ì·¨ íƒ„ìˆ˜í™”ë¬¼ = Food.carbohydrates Ã— multiplier
ì„­ì·¨ ë‹¨ë°±ì§ˆ = Food.protein Ã— multiplier
ì„­ì·¨ ì§€ë°© = Food.fat Ã— multiplier
```

**Usage Example:**
```swift
// 1. Select food and record intake
let rice = Food(name: "ë°±ë¯¸ë°¥", calories: 130, servingSize: 100.0, ...)
let record = FoodRecord(
    userId: userId,
    foodId: rice.id,
    date: Date(),
    mealType: .lunch,
    quantity: 200.0,
    quantityUnit: .gram,
    ...
)

// 2. Calculate nutrition
let nutrition = record.calculateNutrition(from: rice)
// nutrition.calories = 260 kcal (130 Ã— 2.0)
// nutrition.carbohydrates = 57.4g (28.7 Ã— 2.0)
```

### Git Status

- File committed in: 829cb63
- Commit message: "auto-claude: 3.5 - Pure Swift struct for FoodRecord (meal log entry)"
- Implementation plan updated to "completed"
- Phase 3 status: 5/9 subtasks completed

### Architecture Notes

**Transactional Record Pattern:**
- FoodRecord stores actual consumption events
- References immutable Food master data
- Enables consistent nutrition calculations
- Supports meal pattern analysis

**Data Relationships:**
1. **Food (N:1):**
   - Many FoodRecords reference same Food
   - Food is master data, FoodRecord is transactional
   - Avoids duplicating nutrition information

2. **DailyLog (N:1):**
   - Multiple FoodRecords per date aggregate into DailyLog
   - DailyLog calculates daily nutrition totals
   - Grouped by date for dashboard display

**Calculation Strategy:**
- Client-side calculation for immediate feedback
- Server/Core Data stores raw quantity values
- Recalculate when Food nutrition data changes
- Flexible for future unit conversion support

---

## Subtask 3.4: Create Food Domain Entity - âœ… COMPLETED

**Status:** COMPLETED
**File:** Bodii/Domain/Entities/Food.swift
**Commit:** 050ec5d

### Implementation Details

All acceptance criteria have been met:

âœ… **Food struct with Identifiable, Codable, Equatable**
   - Identifiable: Uses UUID as id
   - Codable: All properties are Codable-conforming types
   - Equatable: Auto-synthesized by compiler

âœ… **Nutritional info: calories, carbs, protein, fat, sodium, fiber, sugar**
   - calories: Int (kcal, required)
   - carbohydrates: Decimal (g, required)
   - protein: Decimal (g, required)
   - fat: Decimal (g, required)
   - sodium: Decimal? (mg, optional - API may not provide)
   - fiber: Decimal? (g, optional - API may not provide)
   - sugar: Decimal? (g, optional - API may not provide)

âœ… **Serving info: servingSize, servingUnit**
   - servingSize: Decimal (ê¸°ì¤€ ì œê³µëŸ‰)
   - servingUnit: QuantityUnit? (.gram or .serving, optional)

âœ… **Source tracking: source, apiCode, createdByUserId**
   - source: FoodSource enum (.kfdaAPI, .usdaAPI, .userCreated)
   - apiCode: String? (API ê³ ìœ  ì½”ë“œ, optional for user-created foods)
   - createdByUserId: UUID? (ì‚¬ìš©ì ìƒì„± ìŒì‹ì˜ ìƒì„±ì ID, optional)

### Bonus Features

âœ… **CustomStringConvertible protocol**
   - Provides readable debug description
   - Shows key nutritional info and source
   - Smart servingUnit display (shows displayName if present)

âœ… **Master Data Pattern**
   - Immutable nutritional reference data
   - Referenced by multiple FoodRecord entries
   - Optimized for search and reuse

### Quality Attributes

âœ… Follows established patterns from User, BodyRecord, MetabolismSnapshot entities
âœ… Korean documentation with í•™ìŠµ í¬ì¸íŠ¸ (learning points)
âœ… Comprehensive doc comments with usage examples
âœ… MARK organization for code sections
âœ… Domain entity pattern (separated from Core Data)
âœ… No console.log/print debugging statements
âœ… Detailed property documentation with value ranges

### Documentation Highlights

**í•™ìŠµ í¬ì¸íŠ¸ (Learning Point):**
- Explains Master Data Pattern
- Compares to JPA @OneToMany relationship (Product - OrderItem pattern)
- Food is immutable reference data referenced by many FoodRecord entries

**Key Concepts:**
- Master data vs transactional data separation
- Multiple data sources: KFDA API, USDA API, user-created
- Nutritional information per serving size
- Optional fields for incomplete API data
- Reusable food definitions for meal logging

**Usage Examples:**
```swift
// 1. API food (from KFDA)
let rice = Food(
    id: UUID(),
    name: "ë°±ë¯¸ë°¥",
    calories: 130,
    carbohydrates: 28.7,
    protein: 2.5,
    fat: 0.2,
    sodium: 0,
    fiber: 0.3,
    sugar: 0.1,
    servingSize: 100.0,
    servingUnit: .gram,
    source: .kfdaAPI,
    apiCode: "KFDA_12345",
    createdByUserId: nil,
    createdAt: Date()
)

// 2. User-created food
let customMeal = Food(
    id: UUID(),
    name: "ì—„ë§ˆí‘œ ëœì¥ì°Œê°œ",
    calories: 120,
    servingSize: 1.0,
    servingUnit: .serving,
    source: .userCreated,
    apiCode: nil,
    createdByUserId: userId,
    ...
)
```

### Git Status

- File committed in: 050ec5d
- Commit message: "auto-claude: 3.4 - Pure Swift struct for Food master data"
- Implementation plan updated to "completed"
- Phase 3 status: 4/9 subtasks completed

### Architecture Notes

**Master Data Pattern:**
- Food entities are master data (reference data)
- Reused across multiple FoodRecord entries
- Immutable after creation (var for potential updates in Core Data sync)
- Optimized for search and selection in UI

**Data Sources:**
1. **KFDA API** (ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜)
   - Korean food database
   - Official nutritional data
   - apiCode stores KFDA food code

2. **USDA API** (ë¯¸êµ­ ë†ë¬´ë¶€)
   - International food database
   - Comprehensive nutritional data
   - apiCode stores USDA food ID

3. **User Created**
   - Custom food entries
   - createdByUserId tracks creator
   - No apiCode (user-generated)

**Data Flow:**
1. API sync: Fetch food data from KFDA/USDA â†’ Create Food entities
2. User creates: User inputs nutritional info â†’ Create Food entity with .userCreated source
3. Meal logging: User selects Food â†’ Create FoodRecord with quantity
4. Nutrition calculation: FoodRecord uses Food nutritional data Ã— quantity

**Why Separate Entity from FoodRecord?**
- Avoid duplication: Same food used in multiple meals
- Data integrity: Nutritional info defined once
- Efficiency: Search and select from master data
- Updates: Fix nutritional data in one place affects all records (if needed)

---

## Subtask 3.3: Create MetabolismSnapshot Domain Entity - âœ… COMPLETED

**Status:** COMPLETED
**File:** Bodii/Domain/Entities/MetabolismSnapshot.swift
**Commit:** 527d6ce

### Implementation Details

All acceptance criteria have been met:

âœ… **MetabolismSnapshot struct with Identifiable, Codable, Equatable**
   - Identifiable: Uses UUID as id
   - Codable: All properties are Codable-conforming types
   - Equatable: Auto-synthesized by compiler

âœ… **All properties from ERD:**
   - id: UUID (unique identifier)
   - userId: UUID (foreign key to User)
   - bodyRecordId: UUID (foreign key to BodyRecord for 1:1 relationship)
   - date: Date (same as BodyRecord.date for 1:1 mapping)
   - weight: Decimal (snapshot of body weight at this point in time)
   - bodyFatPct: Decimal (snapshot of body fat percentage)
   - bmr: Int (calculated Basal Metabolic Rate in kcal/day)
   - tdee: Int (calculated Total Daily Energy Expenditure in kcal/day)
   - activityLevel: ActivityLevel enum (activity level used for TDEE calculation)
   - createdAt: Date (creation timestamp)

### Bonus Features

âœ… **CustomStringConvertible protocol**
   - Provides readable debug description
   - Shows all key properties including calculations

### Quality Attributes

âœ… Follows established patterns from User and BodyRecord entities
âœ… Korean documentation with í•™ìŠµ í¬ì¸íŠ¸ (learning points)
âœ… Comprehensive doc comments with calculation formulas
âœ… MARK organization for code sections
âœ… Domain entity pattern (separated from Core Data)
âœ… No console.log/print debugging statements
âœ… Immutable struct with let properties (snapshot pattern)

### Documentation Highlights

**í•™ìŠµ í¬ì¸íŠ¸ (Learning Point):**
- Explains 1:1 Relationship Entity Pattern
- Compares to JPA @OneToOne relationship
- Shows how separate table optimizes historical queries

**Key Concepts:**
- 1:1 relationship with BodyRecord via same date value
- Snapshot pattern: preserves metabolism state at specific point in time
- Enables tracking metabolism changes over time for dashboard charts
- Automatic creation when BodyRecord is saved

**Calculation Formulas:**
```
BMR (Mifflin-St Jeor equation):
  Male: (10 Ã— weight) + (6.25 Ã— height) - (5 Ã— age) + 5
  Female: (10 Ã— weight) + (6.25 Ã— height) - (5 Ã— age) - 161

TDEE:
  TDEE = BMR Ã— activityLevel.multiplier
```

**Usage Example:**
```swift
let snapshot = MetabolismSnapshot(
    id: UUID(),
    userId: userId,
    bodyRecordId: bodyRecord.id,
    date: bodyRecord.date,
    weight: 70.0,
    bodyFatPct: 18.5,
    bmr: 1650,
    tdee: 2550,
    activityLevel: .moderate,
    createdAt: Date()
)
```

### Git Status

- File committed in: 527d6ce
- Commit message: "auto-claude: 3.3 - Pure Swift struct for MetabolismSnapshot (1:1 with BodyRecord)"
- Implementation plan updated to "completed"
- Phase 3 status: 3/9 subtasks completed

### Architecture Notes

**1:1 Relationship Pattern:**
- MetabolismSnapshot and BodyRecord share the same date value
- When BodyRecord is saved, MetabolismSnapshot is automatically created
- Separate entity optimizes queries for metabolism history charts
- Snapshot pattern preserves point-in-time metabolism data

**Data Flow:**
1. User enters body data â†’ BodyRecord created
2. BMR/TDEE calculated using User profile data
3. MetabolismSnapshot created with same date as BodyRecord
4. Both entities saved in same transaction
5. Dashboard queries MetabolismSnapshot for metabolism trends

**Why Separate Entity?**
- Performance: Querying metabolism trends doesn't require loading body composition data
- Clarity: Separates concerns (body data vs metabolism calculations)
- Flexibility: Can query metabolism changes independently
- Optimization: Indexed date column for fast time-range queries

---

## Subtask 3.1: Create User Domain Entity - âœ… COMPLETED

**Status:** COMPLETED
**File:** Bodii/Domain/Entities/User.swift
**Commit:** b23dd39

### Implementation Details

All acceptance criteria have been met:

âœ… **User struct with Identifiable, Codable, Equatable**
   - Identifiable: Uses UUID as id
   - Codable: All properties are Codable-conforming types
   - Equatable: Auto-synthesized by compiler

âœ… **All properties from ERD:**
   - id: UUID (unique identifier)
   - name: String (1-20 chars validated)
   - gender: Gender enum (male/female)
   - birthDate: Date (used for age calculation)
   - height: Decimal (100-250cm range)
   - activityLevel: ActivityLevel enum (sedentary to veryActive)

âœ… **Current values:**
   - currentWeight: Decimal (20-300kg)
   - currentBodyFatPct: Decimal (3-60%)
   - currentMuscleMass: Decimal (10-60kg)
   - currentBMR: Int (calculated via Mifflin-St Jeor)
   - currentTDEE: Int (BMR Ã— activityLevel.multiplier)

âœ… **Timestamps:**
   - metabolismUpdatedAt: Date (when metabolism was last calculated)
   - createdAt: Date (user creation timestamp)
   - updatedAt: Date (last modification timestamp)

âœ… **Computed age property:**
   - Uses Date.age(from: birthDate) extension
   - Automatically calculates current age from birth date
   - Returns Int representing ë§Œ ë‚˜ì´ (Korean age system)

### Bonus Features

âœ… **CustomStringConvertible protocol**
   - Provides readable debug description
   - Shows key properties in formatted output

### Quality Attributes

âœ… Follows established patterns from Phase 1 & 2
âœ… Korean documentation with í•™ìŠµ í¬ì¸íŠ¸ (learning points)
âœ… Comprehensive doc comments with usage examples
âœ… MARK organization for code sections
âœ… Domain entity pattern (separated from Core Data)
âœ… No console.log/print debugging statements
âœ… Clean Architecture principles applied

### Documentation Highlights

**í•™ìŠµ í¬ì¸íŠ¸ (Learning Point):**
- Explains Domain Entity Pattern
- Compares to Clean Architecture in Java/JPA
- Separates business logic from persistence

**Property Documentation:**
- BMR calculation formula: (10 Ã— weight) + (6.25 Ã— height) - (5 Ã— age) + gender constant
- TDEE calculation: BMR Ã— activityLevel.multiplier
- Validation ranges for all numeric properties
- References ValidationService for input validation

**Usage Example:**
```swift
let user = User(
    id: UUID(),
    name: "í™ê¸¸ë™",
    gender: .male,
    birthDate: Date(),
    height: 175.0,
    activityLevel: .moderate,
    currentWeight: 70.0,
    currentBodyFatPct: 18.5,
    currentMuscleMass: 32.0,
    currentBMR: 1650,
    currentTDEE: 2550,
    metabolismUpdatedAt: Date(),
    createdAt: Date(),
    updatedAt: Date()
)
print(user.age) // Automatically calculated
```

### Git Status

- File committed in: b23dd39
- Commit message: "auto-claude: 3.1 - Create User domain entity with all properties and computed age"
- Implementation plan updated to "completed"
- Phase 3 status updated to "in_progress" (1/9 subtasks done)

### Architecture Notes

**Domain Entity Pattern:**
- Pure Swift struct (no Core Data dependencies)
- Used in business logic layer (ViewModels, Services)
- Mapped to/from Core Data via UserEntity+Extensions (Phase 4)
- Improves testability (no NSManagedObject complexity)
- Better separation of concerns

**Data Flow:**
1. Core Data: UserEntity (persistent storage)
2. Extensions: UserEntity+Extensions (mapping layer)
3. Domain: User struct (business logic)
4. ViewModels: Use User struct for presentation logic

---

**Phase 3 Progress:** ğŸš§ IN PROGRESS (5/9 subtasks)
- 3.1: User âœ…
- 3.2: BodyRecord âœ…
- 3.3: MetabolismSnapshot âœ…
- 3.4: Food âœ…
- 3.5: FoodRecord âœ…
- 3.6: ExerciseRecord (pending)
- 3.7: SleepRecord (pending)
- 3.8: DailyLog (pending)
- 3.9: Goal (pending)

**Overall Progress:** Phase 1 (âœ… Complete), Phase 2 (âœ… Complete), Phase 3 (ğŸš§ In Progress - 5/9)
**Next Subtask:** 3.6 - Create ExerciseRecord Domain Entity

---

## Subtask 3.2: Create BodyRecord Domain Entity - âœ… COMPLETED

**Status:** COMPLETED
**File:** Bodii/Domain/Entities/BodyRecord.swift
**Commit:** 8cc9c38

### Implementation Details

All acceptance criteria have been met:

âœ… **BodyRecord struct with Identifiable, Codable, Equatable**
   - Identifiable: Uses UUID as id
   - Codable: All properties are Codable-conforming types
   - Equatable: Auto-synthesized by compiler

âœ… **All properties from ERD:**
   - id: UUID (unique identifier)
   - userId: UUID (foreign key to User)
   - date: Date (unique per day, maps to MetabolismSnapshot)
   - weight: Decimal (20-300kg range)
   - bodyFatMass: Decimal (kg, auto-calculated from bodyFatPercent)
   - bodyFatPercent: Decimal (3-60%, auto-calculated from bodyFatMass)
   - muscleMass: Decimal (10-60kg range)
   - createdAt: Date (creation timestamp)

âœ… **Helper methods for bodyFatMass â†” bodyFatPercent calculation:**
   - Static calculateBodyFatMass(weight:bodyFatPercent:) - Formula: weight Ã— (bodyFatPercent/100)
   - Static calculateBodyFatPercent(weight:bodyFatMass:) - Formula: (bodyFatMass/weight) Ã— 100
   - Factory method from(userId:date:weight:bodyFatPercent:muscleMass:) - Creates record with auto-calculated bodyFatMass
   - Factory method from(userId:date:weight:bodyFatMass:muscleMass:) - Creates record with auto-calculated bodyFatPercent
   - updatingWeight(_:) - Recalculates bodyFatMass when weight changes
   - updatingBodyFatPercent(_:) - Recalculates bodyFatMass when bodyFatPercent changes
   - updatingBodyFatMass(_:) - Recalculates bodyFatPercent when bodyFatMass changes

### Bonus Features

âœ… **Computed leanBodyMass property**
   - Formula: weight - bodyFatMass
   - Used for validation: muscleMass â‰¤ leanBodyMass

âœ… **CustomStringConvertible protocol**
   - Provides readable debug description with all properties
   - Shows computed leanBodyMass value

### Quality Attributes

âœ… Follows established patterns from User.swift
âœ… Korean documentation with í•™ìŠµ í¬ì¸íŠ¸ (learning points)
âœ… Comprehensive doc comments with calculation formulas
âœ… MARK organization for code sections
âœ… Domain entity pattern (separated from Core Data)
âœ… No console.log/print debugging statements
âœ… Immutable by default with functional update methods

### Documentation Highlights

**í•™ìŠµ í¬ì¸íŠ¸ (Learning Point):**
- Explains Auto-calculation Logic pattern
- Compares to JPA @PrePersist/@PreUpdate hooks
- Shows how Swift uses helper methods instead

**Calculation Formulas:**
```
ì²´ì§€ë°©ëŸ‰(kg) = ì²´ì¤‘(kg) Ã— (ì²´ì§€ë°©ë¥ (%) / 100)
ì²´ì§€ë°©ë¥ (%) = (ì²´ì§€ë°©ëŸ‰(kg) / ì²´ì¤‘(kg)) Ã— 100
ì œì§€ë°©ëŸ‰(kg) = ì²´ì¤‘(kg) - ì²´ì§€ë°©ëŸ‰(kg)
```

**Usage Examples:**
- Creating record from bodyFatPercent (auto-calculates bodyFatMass)
- Creating record from bodyFatMass (auto-calculates bodyFatPercent)
- Updating individual values while maintaining consistency

### Git Status

- File committed in: 8cc9c38
- Commit message: "auto-claude: 3.2 - Pure Swift struct for BodyRecord with auto-calculation logic"
- Implementation plan updated to "completed"
- Phase 3 status: 2/9 subtasks completed

### Architecture Notes

**Auto-calculation Pattern:**
- Factory methods ensure calculations happen at creation time
- Update methods return new instances (functional approach)
- Static helpers can be used by Core Data extensions
- Prevents invalid states (bodyFatMass and bodyFatPercent always consistent)

**1:1 Relationship with MetabolismSnapshot:**
- Same date value links to MetabolismSnapshot
- When BodyRecord is saved, MetabolismSnapshot is auto-created
- Both entities track the same body composition snapshot

---
