# Exercise Tracking with MET Calculations - Build Progress

## Status: Planning Complete
Created: 2026-01-13

## Summary
Implementation plan created with 5 phases and 16 subtasks.
Total estimated time: ~10 hours

## Phases Overview
1. Phase 1: Core Services Layer (5 subtasks)
   - ExerciseCalcService, Repositories, ExerciseRecordService

2. Phase 2: UI Layer (7 subtasks)
   - ViewModels, Views, Components

3. Phase 3: Integration and Navigation (2 subtasks)
   - DIContainer, TabView integration

4. Phase 4: Testing (2 subtasks)
   - Unit tests for calc service and enum

5. Phase 5: Custom Exercise Support (1 subtask)
   - Enhanced 'Other' exercise type with custom MET

## Current Progress
- [x] Read spec and project documentation
- [x] Analyzed existing codebase structure
- [x] Created implementation_plan.json
- [x] Phase 1: Core Services Layer (5/5 completed)
- [ ] Phase 2: UI Layer
- [ ] Phase 3: Integration and Navigation
- [ ] Phase 4: Testing
- [ ] Phase 5: Custom Exercise Support

## Key Decisions
1. Using existing ExerciseType.baseMET and metValue(for:) for MET calculations
2. Repositories pattern for Core Data access
3. Service layer handles DailyLog cascade updates
4. Custom MET stored in note field as JSON for 'Other' exercise type

## Dependencies Identified
- Existing: ExerciseRecord, DailyLog, User domain entities
- Existing: ExerciseType, Intensity enums with MET data
- Existing: PersistenceController for Core Data
- Need to create: Repositories, Services, ViewModels, Views

[2026-01-13 - Subtask 1.1 COMPLETED]
✅ ExerciseCalcService Implementation
- Created Bodii/Services/ExerciseCalcService.swift
- Implemented calculateCaloriesBurned() method
- Formula: Calories = MET × weight(kg) × duration(hours)
- Uses ExerciseType.baseMET and Intensity.metMultiplier
- Converts duration from minutes to hours (duration/60)
- Returns rounded Int32 result
- Handles edge cases:
  * Returns 0 when duration is 0
  * Returns 0 when weight is 0 or negative
- Well documented with comprehensive examples
- Committed: a58e02b

All acceptance criteria met ✓

[2026-01-13 - Subtask 1.2 COMPLETED]
✅ ExerciseRecordRepository Implementation
- Created Bodii/Infrastructure/Repositories/ExerciseRecordRepository.swift
- Implemented full CRUD operations:
  * save(exerciseRecord): Creates new or updates existing records
  * fetch(by id): Returns single record by UUID
  * fetchAll(for userId, on date): Returns records for specific date with proper calendar day comparison
  * fetchAll(for userId): Returns all user records sorted by date descending
  * delete(by id): Removes record by UUID
- Proper domain entity to Core Data managed object conversion (convertToDomain)
- User relationship handling (setUserRelationship)
- Comprehensive error handling with RepositoryError enum:
  * entityNotFound: When Core Data entity descriptor is missing
  * invalidData: When required fields are missing or invalid
  * relatedEntityNotFound: When User foreign key reference fails
- Well documented with comprehensive examples
- Committed: e78fa88

All acceptance criteria met ✓

[2026-01-13 - Subtask 1.3 COMPLETED]
✅ DailyLogRepository Implementation
- Created Bodii/Infrastructure/Repositories/DailyLogRepository.swift
- Implemented key operations:
  * getOrCreate(userId, date, defaultBMR, defaultTDEE): Returns existing or creates new DailyLog
  * fetch(by userId, date): Returns single DailyLog with proper calendar day comparison
  * update(dailyLog): Saves changes to existing DailyLog
- Proper domain entity to Core Data managed object conversion (convertToDomain)
- User relationship handling (setUserRelationship)
- Date comparison uses calendar-based start/end of day
- Comprehensive error handling with RepositoryError enum
- Well documented with comprehensive examples
- Committed: [commit hash in git log]

All acceptance criteria met ✓

[2026-01-13 - Subtask 1.4 COMPLETED]
✅ UserRepository Implementation
- Created Bodii/Infrastructure/Repositories/UserRepository.swift
- Implemented fetch operations:
  * fetchCurrentUser(): Returns the single User in the app (first User record)
  * getCurrentWeight(): Returns user's currentWeight as Decimal
- Handles case when no user exists (returns nil)
- Proper domain entity to Core Data managed object conversion (convertToDomain)
- Follows established repository pattern with Core Data integration
- Comprehensive error handling using RepositoryError enum
- Full conversion of all User fields including optional currentWeight, currentBodyFatPct, etc.
- Well documented with comprehensive examples
- Committed: 8292393

All acceptance criteria met ✓

[2026-01-13 - Subtask 1.5 COMPLETED]
✅ ExerciseRecordService Implementation
- Created Bodii/Services/ExerciseRecordService.swift
- Implemented business logic methods:
  * addExercise(): Creates ExerciseRecord and updates DailyLog
    - Validates duration >= 1 minute
    - Fetches user's current weight from UserRepository
    - Calculates calories using ExerciseCalcService
    - Creates ExerciseRecord
    - Updates DailyLog: totalCaloriesOut += calories, exerciseMinutes += duration, exerciseCount += 1
    - Uses DailyLogRepository.getOrCreate for automatic DailyLog creation
  * updateExercise(): Modifies record and adjusts DailyLog delta
    - Validates duration >= 1 minute
    - Fetches old ExerciseRecord
    - Calculates new calories
    - Updates ExerciseRecord
    - Handles same date: adjusts delta in same DailyLog
    - Handles date change: removes from old DailyLog, adds to new DailyLog
  * deleteExercise(): Removes record and decrements DailyLog values
    - Fetches ExerciseRecord
    - Updates DailyLog: totalCaloriesOut -= calories, exerciseMinutes -= duration, exerciseCount -= 1
    - Deletes ExerciseRecord
  * fetchExercises(for:on:): Returns exercises for a specific date
  * fetchExercise(by:): Returns single exercise by ID
- Comprehensive error handling with ServiceError enum:
  * invalidInput: Validation failures (duration < 1, weight not set)
  * recordNotFound: ExerciseRecord not found
  * userNotFound: Current user not found
- All operations maintain transactional consistency
- Well documented with comprehensive examples
- Committed: 672aa3c

All acceptance criteria met ✓

[2026-01-13 - Subtask 2.1 COMPLETED]
✅ ExerciseViewModel Implementation
- Created Bodii/Features/Exercise/ViewModels/ExerciseViewModel.swift
- Manages exercise list and date navigation
- Loads exercises for selected date via ExerciseRecordService
- Date navigation: goToPreviousDay(), goToNextDay(), goToToday()
- Daily statistics from DailyLog: totalCaloriesBurned, totalExerciseMinutes, exerciseCount
- CRUD operations: addExercise(), updateExercise(), deleteExercise()
- Loading and error state management with @Published properties
- Auto-refresh after data changes
- Follows SwiftUI ObservableObject pattern with @MainActor
- Committed: [previous commit]

All acceptance criteria met ✓

[2026-01-13 - Subtask 2.2 COMPLETED]
✅ ExerciseInputViewModel Implementation
- Created Bodii/Features/Exercise/ViewModels/ExerciseInputViewModel.swift
- Manages exercise input form state
- Real-time calorie preview with Combine debounced at 300ms
- Validates duration >= 1 minute with validation messages
- Save action calls ExerciseRecordService for create/update
- Edit mode support with existing record initialization
- Sets shouldDismiss flag on successful save for modal dismissal
- Uses ExerciseCalcService for calorie calculation
- Comprehensive error handling with async/await
- Committed: [previous commit]

All acceptance criteria met ✓

[2026-01-13 - Subtask 2.3 COMPLETED]
✅ ExerciseListView Implementation
- Created Bodii/Features/Exercise/Views/ExerciseListView.swift
- Date navigation header:
  * Previous/Next day buttons with chevron icons
  * Date display with "오늘" button (shows when not today)
  * DateFormatter with Korean locale (yyyy년 M월 d일)
- Daily summary card:
  * Total calories burned with flame icon (orange)
  * Total exercise minutes with clock icon (green)
  * Exercise count with checkmark icon (blue)
  * Data from ViewModel's DailyLog statistics
- Exercise list:
  * Cards with exercise type icon, name, duration, intensity, calories
  * SF Symbol icons: figure.walk, figure.run, bicycle, figure.pool.swim, etc.
  * Color-coded by exercise type (running: blue, cycling: orange, etc.)
  * Intensity icons: circle (low), circle.lefthalf.filled (medium), circle.fill (high)
- Swipe-to-delete with confirmation alert
- Tap-to-edit functionality (modal placeholder for ExerciseInputView)
- Floating add button (blue circle, bottom-right)
- Empty state view with helpful message
- Loading and error alerts
- SwiftUI preview with mock dependencies
- Committed: 41e3854

All acceptance criteria met ✓

## Next Steps
- Phase 2 UI Layer in progress (3/7 completed)
- Continue with remaining UI components:
  * Subtask 2.4: Create ExerciseInputView modal
  * Subtask 2.5: Create ExerciseCardView component
  * Subtask 2.6: Create ExerciseTypeGridView component
  * Subtask 2.7: Add SF Symbol icons to ExerciseType enum
